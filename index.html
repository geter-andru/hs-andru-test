<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H&S Revenue Assessment - Repaired</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Enhanced Color System for Series A Positioning */
            --color-background-primary: #0a0a0a;
            --color-background-secondary: #111111;
            --color-background-tertiary: #1a1a1a;
            --color-background-elevated: #222222;
            --color-surface: #2a2a2a;
            --color-surface-hover: #333333;
            
            --color-text-primary: #ffffff;
            --color-text-secondary: #e5e5e5;
            --color-text-muted: #a3a3a3;
            --color-text-subtle: #737373;
            --color-text-disabled: #525252;
            
            /* Professional Brand Colors */
            --color-brand-primary: #3b82f6;
            --color-brand-secondary: #10b981;
            --color-brand-accent: #8b5cf6;
            --color-accent-warning: #f59e0b;
            --color-accent-danger: #ef4444;
            --color-accent-success: #22c55e;
            
            /* Interactive States */
            --color-hover: rgba(59, 130, 246, 0.08);
            --color-focus: rgba(59, 130, 246, 0.2);
            --color-active: rgba(59, 130, 246, 0.12);
            
            --font-family-primary: 'Red Hat Display', sans-serif;
            --font-family-mono: 'JetBrains Mono', 'Fira Code', monospace;
            
            --font-size-xs: 11px;
            --font-size-sm: 13px;
            --font-size-base: 15px;
            --font-size-lg: 17px;
            --font-size-xl: 19px;
            --font-size-2xl: 23px;
            --font-size-3xl: 27px;
            --font-size-4xl: 33px;
            --font-size-5xl: 41px;
            
            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.625;
            
            /* Enhanced Spacing System */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 24px;
            --spacing-2xl: 32px;
            --spacing-3xl: 48px;
            --spacing-4xl: 64px;
            --spacing-5xl: 96px;
            
            /* Enhanced Layout */
            --container-max-width: 900px;
            --content-max-width: 720px;
            
            /* Enhanced Border Radius */
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 16px;
            --border-radius-xl: 24px;
            --border-radius-full: 50%;
            
            /* Enhanced Transitions */
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Enhanced Shadows */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.1);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.5);
            
            /* Glass Effect */
            --glass-background: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-backdrop: blur(16px);
        }
        
        /* LOADING SCREEN */
        #hs-assessment-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--color-background-primary) 0%, var(--color-background-secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #hs-assessment-loading.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-content {
            text-align: center;
            max-width: 480px;
            padding: var(--spacing-3xl);
            animation: fadeInUp 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .loading-rocket {
            font-size: 48px;
            margin-bottom: var(--spacing-2xl);
            display: inline-block;
            animation: rocketPulse 2s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(6, 182, 212, 0.3));
        }
        
        @keyframes rocketPulse {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
                filter: drop-shadow(0 0 5px rgba(6, 182, 212, 0.3));
            }
            25% {
                transform: scale(1.05) rotate(1deg);
                filter: drop-shadow(0 0 15px rgba(6, 182, 212, 0.5));
            }
            50% { 
                transform: scale(1.1) rotate(2deg);
                filter: drop-shadow(0 0 20px rgba(6, 182, 212, 0.7));
            }
            75% {
                transform: scale(1.05) rotate(1deg);
                filter: drop-shadow(0 0 15px rgba(6, 182, 212, 0.5));
            }
        }
        
        .loading-title {
            color: var(--color-text-primary);
            font-size: var(--font-size-4xl);
            font-weight: 600;
            margin-bottom: var(--spacing-lg);
            opacity: 0;
            animation: fadeInUp 0.8s ease-out 0.3s forwards;
            letter-spacing: -0.025em;
        }
        
        .loading-subtitle {
            color: var(--color-text-muted);
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-4xl);
            line-height: var(--line-height-relaxed);
            opacity: 0;
            animation: fadeInUp 0.8s ease-out 0.5s forwards;
            font-weight: 400;
        }
        
        .loading-progress-container {
            width: 280px;
            height: 6px;
            background: var(--color-surface);
            border-radius: 3px;
            margin: 0 auto var(--spacing-xl);
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            opacity: 0;
            animation: fadeInUp 0.8s ease-out 0.7s forwards;
            position: relative;
        }
        
        .loading-progress-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.1) 50%, transparent 100%);
        }
        
        .loading-progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--color-brand-primary) 0%, var(--color-brand-accent) 100%);
            border-radius: 3px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .loading-progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
            animation: shimmer 2.5s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .loading-status {
            color: var(--color-text-subtle);
            font-size: var(--font-size-sm);
            min-height: 24px;
            font-weight: 500;
            transition: opacity 0.3s ease;
            opacity: 0;
            animation: fadeInUp 0.8s ease-out 0.9s forwards;
            font-family: var(--font-family-mono);
        }
        
        /* QUESTION SYSTEM */
        .question-container {
            margin-bottom: var(--spacing-3xl);
            padding: var(--spacing-3xl);
            background: var(--glass-background);
            backdrop-filter: var(--glass-backdrop);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--glass-border);
            opacity: 0;
            transform: translateY(20px);
            animation: questionFadeIn 0.6s ease-out forwards;
            position: relative;
            overflow: hidden;
        }
        
        .question-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--color-brand-primary) 50%, transparent 100%);
            opacity: 0.6;
        }
        
        @keyframes questionFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .question-category {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, var(--color-brand-primary) 0%, var(--color-brand-accent) 100%);
            color: var(--color-text-primary);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            font-size: var(--font-size-xs);
            font-weight: 600;
            margin-bottom: var(--spacing-xl);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: var(--shadow-sm);
            position: relative;
        }
        
        .question-category::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            pointer-events: none;
        }
        
        .question-title {
            font-size: var(--font-size-2xl);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-md);
            line-height: var(--line-height-tight);
            letter-spacing: -0.025em;
        }
        
        .question-help {
            color: var(--color-text-muted);
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-2xl);
            line-height: var(--line-height-relaxed);
            font-weight: 400;
        }
        
        .question-number {
            color: var(--color-text-subtle);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-xl);
            font-weight: 500;
            font-family: var(--font-family-mono);
            opacity: 0.8;
        }
        
        /* ENHANCED SCALE INPUT */
        .scale-container {
            margin: var(--spacing-3xl) 0;
            padding: var(--spacing-2xl);
            background: var(--color-background-elevated);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--color-surface);
            position: relative;
            overflow: hidden;
        }
        
        .scale-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--color-brand-secondary) 50%, transparent 100%);
            opacity: 0.5;
        }
        
        .scale-input {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--color-surface);
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .scale-input:hover {
            background: var(--color-surface-hover);
        }
        
        .scale-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            border-radius: var(--border-radius-full);
            background: linear-gradient(135deg, var(--color-brand-primary) 0%, var(--color-brand-accent) 100%);
            cursor: pointer;
            border: 3px solid var(--color-background-primary);
            box-shadow: var(--shadow-md), 0 0 0 0 rgba(59, 130, 246, 0.4);
            transition: all 0.2s ease;
            position: relative;
        }
        
        .scale-input::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: var(--shadow-lg), 0 0 0 8px rgba(59, 130, 246, 0.15);
        }
        
        .scale-input::-webkit-slider-thumb:active {
            transform: scale(1.1);
            box-shadow: var(--shadow-md), 0 0 0 12px rgba(59, 130, 246, 0.2);
        }
        
        .scale-input::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: var(--border-radius-full);
            background: linear-gradient(135deg, var(--color-brand-primary) 0%, var(--color-brand-accent) 100%);
            cursor: pointer;
            border: 3px solid var(--color-background-primary);
            box-shadow: var(--shadow-md);
            transition: all 0.2s ease;
        }
        
        .scale-value {
            text-align: center;
            font-size: var(--font-size-5xl);
            font-weight: 300;
            color: var(--color-brand-primary);
            margin: var(--spacing-2xl) 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: var(--font-family-mono);
            letter-spacing: -0.025em;
        }
        
        .scale-value.updating {
            transform: scale(1.1);
            color: var(--color-brand-accent);
        }
        
        .scale-labels {
            display: flex;
            justify-content: space-between;
            margin-top: var(--spacing-xl);
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
            font-weight: 500;
            gap: var(--spacing-md);
        }
        
        .scale-labels span {
            flex: 1;
            text-align: center;
        }
        
        .scale-labels span:first-child {
            text-align: left;
        }
        
        .scale-labels span:last-child {
            text-align: right;
        }
        
        /* ENHANCED RADIO OPTIONS */
        .radio-group {
            display: grid;
            gap: var(--spacing-md);
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            padding: var(--spacing-xl);
            background: var(--color-background-elevated);
            border: 2px solid var(--color-surface);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        
        .radio-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, var(--color-hover) 50%, transparent 100%);
            transition: left 0.5s ease;
        }
        
        .radio-option:hover {
            border-color: var(--color-brand-primary);
            background: var(--color-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .radio-option:hover::before {
            left: 100%;
        }
        
        .radio-option.selected {
            border-color: var(--color-brand-primary);
            background: var(--color-hover);
            box-shadow: 0 0 0 1px var(--color-brand-primary);
        }
        
        .radio-option.selected::after {
            content: '✓';
            position: absolute;
            right: var(--spacing-xl);
            color: var(--color-brand-primary);
            font-weight: 600;
            font-size: var(--font-size-xl);
            opacity: 0;
            transform: scale(0.8) rotate(-10deg);
            animation: checkmarkAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        @keyframes checkmarkAppear {
            to {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }
        
        .radio-input {
            margin-right: var(--spacing-lg);
            accent-color: var(--color-brand-primary);
            transform: scale(1.3);
            cursor: pointer;
        }
        
        .radio-text {
            font-weight: 500;
            color: var(--color-text-secondary);
            line-height: var(--line-height-normal);
            flex: 1;
        }
        
        .radio-option:hover .radio-text {
            color: var(--color-text-primary);
        }
        
        .radio-option.selected .radio-text {
            color: var(--color-text-primary);
        }
        
        /* ENHANCED NAVIGATION */
        .assessment-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--spacing-3xl);
            padding-top: var(--spacing-2xl);
            border-top: 1px solid var(--color-surface);
            position: relative;
        }
        
        .assessment-navigation::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--color-brand-primary) 50%, transparent 100%);
        }
        
        .nav-info {
            color: var(--color-text-muted);
            font-size: var(--font-size-sm);
            font-weight: 500;
            font-family: var(--font-family-mono);
        }
        
        .question-progress {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
            background: var(--color-background-elevated);
            padding: var(--spacing-lg) var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--color-surface);
        }
        
        .progress-text {
            font-weight: 500;
            font-family: var(--font-family-mono);
        }
        
        .progress-percentage {
            color: var(--color-brand-primary);
            font-weight: 600;
            font-family: var(--font-family-mono);
        }
        
        /* ENHANCED BASE STYLES */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-family-primary);
            background: var(--color-background-primary);
            color: var(--color-text-secondary);
            line-height: var(--line-height-normal);
            font-size: var(--font-size-base);
            scroll-behavior: smooth;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .assessment-container {
            max-width: var(--container-max-width);
            margin: 0 auto;
            padding: var(--spacing-xl);
            min-height: 100vh;
            transition: opacity var(--transition-slow);
        }
        
        .content-section {
            background: var(--glass-background);
            backdrop-filter: var(--glass-backdrop);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-3xl);
            margin-bottom: var(--spacing-2xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--glass-border);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }
        
        .content-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--color-brand-primary) 50%, transparent 100%);
            opacity: 0.3;
        }
        
        .content-section:hover {
            border-color: var(--color-brand-primary);
            box-shadow: var(--shadow-xl);
        }
        
        .section-title {
            font-size: var(--font-size-4xl);
            font-weight: 700;
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-md);
            opacity: 0;
            animation: fadeInUp 0.8s ease-out forwards;
            letter-spacing: -0.025em;
            line-height: var(--line-height-tight);
        }
        
        .section-subtitle {
            color: var(--color-text-muted);
            margin-bottom: var(--spacing-3xl);
            font-size: var(--font-size-lg);
            line-height: var(--line-height-relaxed);
            font-weight: 400;
        }
        
        /* ENHANCED FORMS */
        .form-group {
            margin-bottom: var(--spacing-2xl);
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-sm);
            letter-spacing: 0.025em;
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--spacing-lg) var(--spacing-xl);
            border: 2px solid var(--color-surface);
            border-radius: var(--border-radius-md);
            font-size: var(--font-size-base);
            background: var(--color-background-elevated);
            color: var(--color-text-primary);
            font-family: inherit;
            transition: all var(--transition-normal);
            position: relative;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--color-brand-primary);
            box-shadow: 0 0 0 3px var(--color-focus);
            background: var(--color-background-secondary);
        }
        
        .form-input:hover,
        .form-select:hover,
        .form-textarea:hover {
            border-color: var(--color-surface-hover);
            background: var(--color-background-secondary);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
            line-height: var(--line-height-relaxed);
        }
        
        .form-help {
            display: block;
            color: var(--color-text-subtle);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-md);
            line-height: var(--line-height-normal);
            font-weight: 400;
        }
        
        /* ENHANCED BUTTONS */
        .btn {
            padding: var(--spacing-lg) var(--spacing-2xl);
            border-radius: var(--border-radius-md);
            font-weight: 600;
            font-size: var(--font-size-base);
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-md);
            font-family: inherit;
            text-decoration: none;
            transition: all var(--transition-normal);
            user-select: none;
            position: relative;
            overflow: hidden;
            min-height: 48px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.1) 50%, transparent 100%);
            transition: left 0.5s ease;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--color-brand-primary) 0%, var(--color-brand-accent) 100%);
            color: var(--color-text-primary);
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--color-background-elevated);
            color: var(--color-text-secondary);
            border: 2px solid var(--color-surface);
        }
        
        .btn-secondary:hover {
            background: var(--color-surface);
            color: var(--color-text-primary);
            border-color: var(--color-surface-hover);
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--color-brand-secondary) 0%, var(--color-accent-success) 100%);
            color: var(--color-text-primary);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            pointer-events: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: var(--spacing-md);
        }
        
        /* ENHANCED PROGRESS */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-surface);
            border-radius: 4px;
            margin-bottom: var(--spacing-xl);
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.1) 50%, transparent 100%);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-brand-primary) 0%, var(--color-brand-accent) 100%);
            border-radius: 4px;
            transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%);
            animation: shimmer 2s ease-in-out infinite;
        }
        
        /* ENHANCED STEPS */
        .assessment-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-3xl);
            padding: 0 var(--spacing-xl);
            background: var(--color-background-elevated);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            border: 1px solid var(--color-surface);
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 18px;
            right: -50%;
            width: 100%;
            height: 3px;
            background: var(--color-surface);
            z-index: -1;
            border-radius: 2px;
            transition: all var(--transition-normal);
        }
        
        .step.active::after,
        .step.completed::after {
            background: linear-gradient(90deg, var(--color-brand-primary) 0%, var(--color-brand-accent) 100%);
        }
        
        .step-circle {
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius-full);
            background: var(--color-surface);
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--spacing-lg);
            font-weight: 600;
            font-size: var(--font-size-sm);
            border: 3px solid var(--color-surface);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }
        
        .step-circle::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .step.active .step-circle,
        .step.completed .step-circle {
            background: linear-gradient(135deg, var(--color-brand-primary) 0%, var(--color-brand-accent) 100%);
            color: var(--color-text-primary);
            border-color: var(--color-brand-primary);
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
        }
        
        .step.active .step-circle::before,
        .step.completed .step-circle::before {
            opacity: 1;
        }
        
        .step-label {
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--color-text-muted);
            transition: color var(--transition-normal);
        }
        
        .step.active .step-label,
        .step.completed .step-label {
            color: var(--color-brand-primary);
            font-weight: 600;
        }
        
        /* ENHANCED UTILITIES */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        /* ENHANCED ANIMATIONS */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(24px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fadeInUp 0.8s ease-out forwards;
        }
        
        /* ENHANCED ERROR STYLES */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-accent-danger);
            color: var(--color-accent-danger);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            margin: var(--spacing-lg) 0;
            font-size: var(--font-size-sm);
            font-weight: 500;
        }
        
        .success-message {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--color-accent-success);
            color: var(--color-accent-success);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            margin: var(--spacing-lg) 0;
            font-size: var(--font-size-sm);
            font-weight: 500;
        }
        
        /* ENHANCED MOBILE-FIRST RESPONSIVE DESIGN */
        /* Mobile devices (up to 768px) */
        @media (max-width: 768px) {
            :root {
                --font-size-xs: 10px;
                --font-size-sm: 12px;
                --font-size-base: 14px;
                --font-size-lg: 16px;
                --font-size-xl: 18px;
                --font-size-2xl: 20px;
                --font-size-3xl: 24px;
                --font-size-4xl: 28px;
                --font-size-5xl: 32px;
            }
            
            .assessment-container {
                padding: var(--spacing-lg);
            }
            
            .content-section {
                padding: var(--spacing-2xl);
                margin-bottom: var(--spacing-lg);
                border-radius: var(--border-radius-md);
            }
            
            .question-container {
                padding: var(--spacing-2xl);
                margin-bottom: var(--spacing-2xl);
                border-radius: var(--border-radius-md);
            }
            
            .question-title {
                font-size: var(--font-size-xl);
                line-height: var(--line-height-normal);
                margin-bottom: var(--spacing-lg);
            }
            
            .question-help {
                font-size: var(--font-size-sm);
                line-height: var(--line-height-relaxed);
                margin-bottom: var(--spacing-2xl);
            }
            
            /* Enhanced Mobile Scale Inputs */
            .scale-container {
                margin: var(--spacing-2xl) 0;
                padding: var(--spacing-xl);
                background: var(--color-background-primary);
                border: 2px solid var(--color-brand-primary);
                border-radius: var(--border-radius-md);
            }
            
            .scale-input {
                height: 10px;
                margin: var(--spacing-xl) 0;
            }
            
            .scale-input::-webkit-slider-thumb {
                width: 32px;
                height: 32px;
                border: 4px solid var(--color-background-primary);
            }
            
            .scale-value {
                font-size: var(--font-size-4xl);
                margin: var(--spacing-2xl) 0;
                padding: var(--spacing-lg);
                background: var(--color-background-elevated);
                border-radius: var(--border-radius-md);
            }
            
            .scale-labels {
                font-size: var(--font-size-sm);
                margin-top: var(--spacing-xl);
                line-height: var(--line-height-normal);
            }
            
            /* Enhanced Mobile Radio Options */
            .radio-option {
                padding: var(--spacing-xl);
                margin-bottom: var(--spacing-md);
                border-width: 2px;
                border-radius: var(--border-radius-md);
                min-height: 56px;
                display: flex;
                align-items: center;
            }
            
            .radio-input {
                width: 20px;
                height: 20px;
                margin-right: var(--spacing-lg);
            }
            
            .radio-text {
                font-size: var(--font-size-base);
                line-height: var(--line-height-relaxed);
            }
            
            /* Enhanced Touch-Friendly Navigation */
            .assessment-navigation {
                flex-direction: column;
                gap: var(--spacing-xl);
                text-align: center;
                padding-top: var(--spacing-2xl);
            }
            
            .assessment-navigation .btn {
                width: 100%;
                max-width: none;
                padding: var(--spacing-xl) var(--spacing-2xl);
                font-size: var(--font-size-lg);
                min-height: 56px;
                border-radius: var(--border-radius-md);
            }
            
            .nav-info {
                order: -1;
                padding: var(--spacing-lg);
                background: var(--color-background-elevated);
                border-radius: var(--border-radius-md);
                font-size: var(--font-size-base);
                border: 1px solid var(--color-surface);
            }
            
            /* Enhanced Mobile Progress Indicators */
            .question-progress {
                flex-direction: column;
                gap: var(--spacing-lg);
                margin-bottom: var(--spacing-2xl);
                padding: var(--spacing-xl);
                background: var(--color-background-elevated);
                border-radius: var(--border-radius-md);
                border: 1px solid var(--color-surface);
            }
            
            .progress-bar {
                height: 8px;
                margin: 0;
            }
            
            /* Enhanced Mobile Step Indicators */
            .assessment-steps {
                padding: var(--spacing-lg);
                margin-bottom: var(--spacing-2xl);
                border-radius: var(--border-radius-md);
            }
            
            .step-label {
                font-size: var(--font-size-xs);
            }
            
            .step-circle {
                width: 32px;
                height: 32px;
                font-size: var(--font-size-sm);
            }
            
            .section-title {
                font-size: var(--font-size-3xl);
                text-align: center;
                margin-bottom: var(--spacing-xl);
            }
            
            .section-subtitle {
                text-align: center;
                font-size: var(--font-size-base);
                margin-bottom: var(--spacing-2xl);
            }
            
            .loading-title {
                font-size: var(--font-size-3xl);
            }
            
            .loading-subtitle {
                font-size: var(--font-size-base);
            }
            
            .loading-rocket {
                font-size: 48px;
            }
        }
        
        /* Small mobile devices (up to 480px) */
        @media (max-width: 480px) {
            .assessment-container {
                padding: var(--spacing-md);
            }
            
            .content-section {
                padding: var(--spacing-lg);
                border-radius: var(--border-radius-sm);
            }
            
            .question-container {
                padding: var(--spacing-lg);
                border-radius: var(--border-radius-sm);
            }
            
            .question-title {
                font-size: var(--font-size-lg);
                font-weight: 600;
            }
            
            .question-help {
                font-size: var(--font-size-xs);
            }
            
            .scale-input::-webkit-slider-thumb {
                width: 28px;
                height: 28px;
                border: 3px solid var(--color-background-primary);
            }
            
            .scale-value {
                font-size: var(--font-size-3xl);
                padding: var(--spacing-md);
            }
            
            .radio-option {
                padding: var(--spacing-lg);
                min-height: 52px;
            }
            
            .radio-text {
                font-size: var(--font-size-sm);
            }
            
            .section-title {
                font-size: var(--font-size-2xl);
            }
            
            .loading-title {
                font-size: var(--font-size-2xl);
            }
            
            .loading-subtitle {
                font-size: var(--font-size-sm);
            }
            
            .loading-rocket {
                font-size: 40px;
            }
        }
        
        /* Landing Page Styles */
        .assessment-steps.hidden {
            display: none;
        }
        
        /* Enhanced Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .radio-option {
                min-height: 64px;
                padding: var(--spacing-xl);
            }
            
            .btn {
                min-height: 52px;
                padding: var(--spacing-lg) var(--spacing-xl);
            }
            
            .scale-input::-webkit-slider-thumb {
                width: 36px;
                height: 36px;
            }
            
            .form-input,
            .form-select,
            .form-textarea {
                min-height: 52px;
                font-size: 16px; /* Prevent zoom on iOS */
                padding: var(--spacing-lg) var(--spacing-xl);
            }
            
            .step-circle {
                width: 40px;
                height: 40px;
            }
        }
        
        /* Enhanced High-DPI Displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .loading-rocket {
                image-rendering: -webkit-optimize-contrast;
            }
            
            .btn::before {
                will-change: transform;
            }
        }
        
        /* Enhanced Landscape Mobile Optimization */
        @media (max-width: 768px) and (orientation: landscape) {
            .loading-content {
                max-width: 600px;
                padding: var(--spacing-xl);
            }
            
            .question-container {
                padding: var(--spacing-lg);
            }
            
            .scale-container {
                margin: var(--spacing-lg) 0;
                padding: var(--spacing-lg);
            }
            
            .assessment-navigation {
                flex-direction: row;
                gap: var(--spacing-lg);
            }
            
            .nav-info {
                order: 0;
            }
        }
        
        /* Enhanced Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            .loading-rocket {
                animation: none;
                transform: scale(1);
            }
            
            .loading-progress-bar::before,
            .progress-fill::before,
            .btn::before {
                animation: none;
            }
            
            .loading-content * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
            }
            
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Enhanced Dark Mode Support (Future-proofing) */
        @media (prefers-color-scheme: dark) {
            :root {
                --glass-background: rgba(255, 255, 255, 0.02);
                --glass-border: rgba(255, 255, 255, 0.05);
            }
        }
        
        /* Enhanced Print Styles */
        @media print {
            .loading-content,
            .assessment-navigation,
            .btn {
                display: none !important;
            }
            
            .content-section {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #000;
            }
        }
    </style>
</head>
<body>
    
    <!-- LOADING SCREEN -->
    <div id="hs-assessment-loading">
        <div class="loading-content">
            <div class="loading-rocket">🚀</div>
            <h1 class="loading-title">H&S Revenue Assessment</h1>
            <p class="loading-subtitle">Systematic Performance Analysis for Technical Founders</p>
            
            <div class="loading-progress-container">
                <div class="loading-progress-bar" id="loading-progress"></div>
            </div>
            
            <p class="loading-status" id="loading-status">Initializing assessment services...</p>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div class="assessment-container" id="main-assessment-container" style="opacity: 0;">
        


        <!-- PROGRESS STEPS -->
        <div class="assessment-steps hidden">
            <div class="step active" id="step-1">
                <div class="step-circle">1</div>
                <div class="step-label">User Details</div>
            </div>
            <div class="step" id="step-2">
                <div class="step-circle">2</div>
                <div class="step-label">Assessment</div>
            </div>
            <div class="step" id="step-3">
                <div class="step-circle">3</div>
                <div class="step-label">Analysis</div>
            </div>
            <div class="step" id="step-4">
                <div class="step-circle">4</div>
                <div class="step-label">Challenges</div>
            </div>
            <div class="step" id="step-5">
                <div class="step-circle">5</div>
                <div class="step-label">Solutions</div>
            </div>
        </div>

        <!-- LANDING PAGE -->
        <div class="content-section" id="landing-section">
            <!-- Hero Section -->
            <div style="text-align: center; margin-bottom: var(--spacing-4xl);">
                <h1 style="font-size: clamp(2.5rem, 5vw, 3.5rem); font-weight: 600; color: var(--color-text-primary); margin-bottom: var(--spacing-lg); line-height: 1.2;">
                    Are You Ready for Sales Tools?
                </h1>
                <p style="font-size: var(--font-size-xl); color: var(--color-text-secondary); margin-bottom: var(--spacing-2xl); max-width: 600px; margin-left: auto; margin-right: auto;">
                    5-minute assessment reveals if you need foundation work first.
                </p>
                
                <button class="btn btn-primary" onclick="startFromLanding()" style="padding: var(--spacing-lg) var(--spacing-3xl); font-size: var(--font-size-lg); margin-bottom: var(--spacing-lg);">
                    Start Assessment
                </button>
                
                <p style="color: var(--color-text-muted); font-size: var(--font-size-sm);">
                    500+ technical founders tested
                </p>
            </div>

            <!-- Assessment Preview -->
            <div style="background: var(--color-background-secondary); padding: var(--spacing-2xl); border-radius: var(--border-radius-lg); margin-bottom: var(--spacing-3xl); max-width: 800px; margin-left: auto; margin-right: auto;">
                <h2 style="font-size: var(--font-size-xl); font-weight: 600; color: var(--color-text-primary); margin-bottom: var(--spacing-lg); text-align: center;">
                    Assessment Preview
                </h2>
                <p style="color: var(--color-text-secondary); line-height: 1.6; margin-bottom: var(--spacing-lg);">
                    <strong>Sample questions:</strong> How confident are you presenting to executives? Can you predict common objections? How effectively do you translate features to business benefits?
                </p>
                <p style="color: var(--color-brand-primary); font-weight: 500; text-align: center;">
                    Get your readiness score vs. other Series A companies.
                </p>
            </div>

            <!-- Trust Section -->
            <div style="text-align: center; padding: var(--spacing-xl); background: var(--color-background-tertiary); border-radius: var(--border-radius-md); max-width: 700px; margin: 0 auto;">
                <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-lg);">
                    No sales calls required. Results delivered immediately.
                </p>
                <p style="color: var(--color-text-muted); font-size: var(--font-size-sm); margin-bottom: var(--spacing-md);">
                    Used by technical founders at
                </p>
                
                <!-- Company Logos Placeholder -->
                <div style="display: flex; justify-content: center; align-items: center; gap: var(--spacing-xl); flex-wrap: wrap;">
                    <div style="padding: var(--spacing-md) var(--spacing-lg); background: var(--color-background-primary); border-radius: var(--border-radius-sm); color: var(--color-text-muted); font-size: var(--font-size-sm); border: 1px solid var(--color-surface);">
                        Series A Co.
                    </div>
                    <div style="padding: var(--spacing-md) var(--spacing-lg); background: var(--color-background-primary); border-radius: var(--border-radius-sm); color: var(--color-text-muted); font-size: var(--font-size-sm); border: 1px solid var(--color-surface);">
                        TechStart Inc.
                    </div>
                    <div style="padding: var(--spacing-md) var(--spacing-lg); background: var(--color-background-primary); border-radius: var(--border-radius-sm); color: var(--color-text-muted); font-size: var(--font-size-sm); border: 1px solid var(--color-surface);">
                        B2B Scale Co.
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 1: USER DETAILS -->
        <div class="content-section hidden" id="user-details-section">
            <h1 class="section-title">Welcome to Your Revenue Assessment</h1>
            <p class="section-subtitle">Tell us about your product and business to get personalized recommendations</p>
            
            <div id="user-details-form">
                <div class="form-group">
                    <label class="form-label" for="email">Email Address *</label>
                    <input type="email" id="email" class="form-input" required 
                           autocomplete="email"
                           placeholder="founder@company.com"
                           aria-describedby="email-help">
                    <small id="email-help" class="form-help">We'll send your results to this address</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="productName">Product Name *</label>
                    <input type="text" id="productName" class="form-input" required 
                           autocomplete="organization"
                           placeholder="Your product or service name"
                           aria-describedby="product-help">
                    <small id="product-help" class="form-help">What do you call your main product or service?</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="businessModel">Business Model *</label>
                    <select id="businessModel" class="form-select" required 
                            autocomplete="off"
                            aria-describedby="model-help">
                        <option value="">Select your business model</option>
                        <option value="b2b">B2B (Business to Business)</option>
                        <option value="b2c">B2C (Business to Consumer)</option>
                    </select>
                    <small id="model-help" class="form-help">Do you sell to other businesses or directly to consumers?</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="productDescription">Product Description *</label>
                    <textarea id="productDescription" class="form-textarea" required 
                              autocomplete="off"
                              placeholder="Describe what your product does and the main problems it solves..."
                              aria-describedby="description-help"></textarea>
                    <small id="description-help" class="form-help">Help us understand what value you provide to customers</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="distinguishingFeature">Key Distinguishing Feature *</label>
                    <input type="text" id="distinguishingFeature" class="form-input" required 
                           autocomplete="off"
                           placeholder="What makes your product unique?"
                           aria-describedby="feature-help">
                    <small id="feature-help" class="form-help">What's your main competitive advantage?</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="customerCount">Current Customer Count *</label>
                    <select id="customerCount" class="form-select" required 
                            autocomplete="off"
                            aria-describedby="count-help">
                        <option value="">Select your customer count</option>
                        <option value="0">0 (Pre-launch)</option>
                        <option value="1-10">1-10 customers</option>
                        <option value="11-50">11-50 customers</option>
                        <option value="51-200">51-200 customers</option>
                        <option value="200+">200+ customers</option>
                    </select>
                    <small id="count-help" class="form-help">How many paying customers do you currently have?</small>
                </div>

                <button type="button" id="start-assessment-btn" class="btn btn-primary">
                    🚀 Start Assessment
                    <span class="loading-spinner hidden" id="user-loading">⏳</span>
                </button>
                
                <p style="color: var(--color-text-subtle); font-size: var(--font-size-xs); margin-top: var(--spacing-lg); text-align: center;">
                    📊 14 questions • ⏱️ ~5-8 minutes • 💾 Progress automatically saved
                </p>
            </div>
        </div>

        <!-- STEP 2: ASSESSMENT -->
        <div class="content-section hidden" id="assessment-section">
            <h2 class="section-title">Revenue Performance Assessment</h2>
            <p class="section-subtitle">14 questions across buyer understanding (60%) and tech-to-value translation (40%)</p>
            
            <div class="question-progress">
                <span class="progress-text">Progress:</span>
                <span class="progress-percentage" id="progress-percentage">0%</span>
                <div class="progress-bar" style="flex: 1; margin-left: var(--spacing-lg);">
                    <div class="progress-fill" id="assessment-progress" style="width: 0%"></div>
                </div>
            </div>
            
            <div id="question-container">
                <div class="question-container" style="text-align: center; padding: var(--spacing-4xl);">
                    <div style="font-size: 48px; margin-bottom: var(--spacing-2xl);">📋</div>
                    <h3 style="color: var(--color-text-muted); margin-bottom: var(--spacing-lg);">Assessment Ready</h3>
                    <p style="color: var(--color-text-subtle);">Click "Start Assessment" to begin the 14-question evaluation</p>
                </div>
            </div>

            <div class="assessment-navigation hidden" id="assessment-navigation">
                <button type="button" class="btn btn-secondary" id="prev-question" disabled>
                    ← Previous
                </button>
                
                <div class="nav-info">
                    <span id="question-counter">Question 1 of 14</span>
                </div>
                
                <button type="button" class="btn btn-primary" id="next-question" disabled>
                    Next →
                </button>
                
                <button type="button" class="btn btn-success hidden" id="complete-assessment">
                    Complete Assessment
                    <span class="loading-spinner hidden" id="assessment-loading">⏳</span>
                </button>
            </div>
        </div>

        <!-- STEP 3: ANALYTICS -->
        <div class="content-section hidden" id="analytics-section">
            <h2 class="section-title">Your Revenue Performance Analysis</h2>
            <p class="section-subtitle">Based on your responses, here's how you score across key revenue capabilities</p>
            
            <div id="analytics-content">
                <div style="text-align: center; padding: var(--spacing-4xl);">
                    <div style="font-size: 48px; margin-bottom: var(--spacing-2xl);">📊</div>
                    <h3 style="color: var(--color-text-muted); margin-bottom: var(--spacing-lg);">Analysis Complete</h3>
                    <p style="color: var(--color-text-subtle);">Your performance analysis results are ready</p>
                </div>
            </div>
        </div>

        <!-- STEP 4: CHALLENGES -->
        <div class="content-section hidden" id="challenges-section">
            <h2 class="section-title">Challenge Detection</h2>
            <p class="section-subtitle">Identified areas for revenue optimization</p>
            
            <div id="challenges-list">
                <div style="text-align: center; padding: var(--spacing-4xl);">
                    <div style="font-size: 48px; margin-bottom: var(--spacing-2xl);">🔍</div>
                    <h3 style="color: var(--color-text-muted); margin-bottom: var(--spacing-lg);">Challenge Analysis Complete</h3>
                    <p style="color: var(--color-text-subtle);">Your specific optimization opportunities have been identified</p>
                </div>
            </div>
        </div>

        <!-- STEP 5: SOLUTIONS -->
        <div class="content-section hidden" id="recommendations-section">
            <h2 class="section-title">Solution Recommendations</h2>
            <p class="section-subtitle">Personalized solutions based on your assessment</p>
            
            <div id="recommendations-list">
                <div style="text-align: center; padding: var(--spacing-4xl);">
                    <div style="font-size: 48px; margin-bottom: var(--spacing-2xl);">💡</div>
                    <h3 style="color: var(--color-text-muted); margin-bottom: var(--spacing-lg);">Recommendations Ready</h3>
                    <p style="color: var(--color-text-subtle);">Your customized solution recommendations are available</p>
                </div>
            </div>
        </div>

        <!-- ERROR HANDLING -->
        <div class="content-section hidden" id="error-container" style="border-color: var(--color-accent-danger);">
            <h2 class="section-title" style="color: var(--color-accent-danger);">Something went wrong</h2>
            <div id="error-message" style="color: var(--color-text-muted); margin-bottom: var(--spacing-xl);"></div>
            <button type="button" class="btn btn-secondary" onclick="location.reload()">Refresh Page</button>
        </div>
    </div>

    <script>
        // =============================================================================
        // AIRTABLE INTEGRATION CONFIGURATION
        // =============================================================================
        
        // Airtable Configuration - REPLACE WITH YOUR ACTUAL VALUES
        const AIRTABLE_BASE_ID = 'app0jJkgTCqn46vp9'; // Airtable base URL
        const AIRTABLE_API_KEY = 'pat4jn6JyCcBrpqBN.96b92bd8cc46aa9e05ec9d75e0d1f8da3dd1ceafec8856fcc962d69d82b84aae'; // Get this from Airtable Account > Developers
        const AIRTABLE_ASSESSMENT_TABLE = 'assessment results'; // Your table name
        
        // Airtable integration functions
        async function saveToAirtable(data) {
            // Use Netlify Function to avoid CORS issues
            const url = '/.netlify/functions/submit-to-airtable';
            
            try {
                // Prepare the fields object
                const fields = {
                            'andru User email': data.email,
                            'Qualification Score': data.overallScore,
                            'Revenue Opportunity Amount': parseFloat(data.revenueOpportunity.replace(/[^0-9.]/g, '')),
                            'ROI Multiplier': data.roiMultiplier || 0,
                            'Is High Priority': data.isHighPriority || false,
                            'Lead Priority': data.leadPriority || 'Medium',
                            'Source': 'Wix Assessment Tool',
                            'Version': 'MVP v1.0',
                            'Browser': navigator.userAgent,
                            
                            // Assessment details
                            'Product Name': data.productName,
                            'Business Model': data.businessModel,
                            'Customer Count': data.customerCount,
                            'Distinguishing Feature': data.distinguishingFeature,
                            
                            // Scores breakdown
                            'Buyer Understanding Score': data.buyerScore,
                            'Tech-to-Value Score': data.techScore,
                            'Focus Area': data.focusArea,
                            'Risk Level': data.riskLevel,
                            'Challenges Count': data.challengesCount,
                            
                            // Responses (as JSON string)
                            'Assessment Responses': JSON.stringify(data.responses),
                            
                            // Timing data
                            'Assessment Started': data.startTime,
                            'Assessment Completed': new Date().toISOString(),
                            'Time to Complete (minutes)': Math.round((Date.now() - new Date(data.startTime)) / 60000),
                            
                            // Conversion tracking
                            'Session ID': data.sessionId,
                            'Conversion Stage': 'Assessment Complete',
                            'Next Action': 'Waitlist Redirect'
                        };
                
                // Send to Netlify Function
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(fields)
                });
        
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Data saved to Airtable:', result.id);
                    return { success: true, recordId: result.id };
                } else {
                    const errorText = await response.text();
                    console.error('❌ Airtable API error:', response.status, errorText);
                    throw new Error(`Airtable API error: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('❌ Airtable save error:', error);
                console.error('Failed data:', data);
                return { success: false, error: error.message };
            }
        }
        
        // Helper functions for Airtable data
        function calculateRevenueOpportunity(analysisResults) {
            const score = analysisResults?.overall?.score || 0;
            if (score < 40) return '$1.2M';
            else if (score < 60) return '$750K';
            else if (score < 80) return '$400K';
            else return '$200K';
        }
        
        function calculateROIMultiplier(analysisResults) {
            const score = analysisResults?.overall?.score || 0;
            return Math.max(2, Math.round(10 - (score / 10)));
        }
        
        function calculateChallengesCount(analysisResults) {
            const score = analysisResults?.overall?.score || 0;
            if (score < 30) return 6;
            else if (score < 50) return 4;
            else if (score < 70) return 2;
            else return 1;
        }
        
        // =============================================================================
        // REPAIRED: COMPLETE ASSESSMENT SYSTEM
        // =============================================================================
        
        // Global state
        let assessmentState = {
            currentStep: 1,
            userDetails: {},
            initialized: false,
            loadingCompleted: false,
            startTime: Date.now(),
            sessionId: `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            
            currentQuestionIndex: 0,
            responses: {},
            assessmentStartTime: null,
            assessmentCompleted: false,
            currentQuestion: null,
            
            analysisResults: null,
            analyticsCompleted: false,
            
            detectedChallenges: null,
            challengesCompleted: false,
            
            recommendations: null,
            recommendationsCompleted: false,
            
            errors: [],
            lastError: null,
            
            // Waitlist integration context
            waitlistContext: null
        };

        // =============================================================================
        // REPAIRED: ENHANCED CONVERSION TRACKING & COHORT ANALYSIS SYSTEM
        // =============================================================================
        
        const CohortTracker = {
            cohorts: {
                'assessment-qualified': [],
                'direct-signup': [],
                'organic-traffic': []
            },
            
            events: [],
            
            trackUserJourney: function(userId, cohortType, stage, data = {}) {
                try {
                    const event = {
                        userId: userId || assessmentState.sessionId,
                        cohortType: cohortType,
                        stage: stage, // 'landing', 'assessment-start', 'assessment-complete', 'waitlist', 'payment'
                        timestamp: Date.now(),
                        data: data,
                        sessionId: assessmentState.sessionId
                    };
                    
                    this.events.push(event);
                    
                    if (!this.cohorts[cohortType]) {
                        this.cohorts[cohortType] = [];
                    }
                    
                    const existingUser = this.cohorts[cohortType].find(u => u.userId === event.userId);
                    if (existingUser) {
                        existingUser.journey.push(event);
                        existingUser.lastActivity = Date.now();
                    } else {
                        this.cohorts[cohortType].push({
                            userId: event.userId,
                            cohortType: cohortType,
                            journey: [event],
                            firstSeen: Date.now(),
                            lastActivity: Date.now()
                        });
                    }
                    
                    console.log(`📊 Cohort Event: ${cohortType} → ${stage}`, event);
                    
                } catch (error) {
                    ErrorHandler.logError('Cohort tracking error', error);
                }
            },
            
            calculateConversionRates: function() {
                try {
                    const rates = {};
                    
                    Object.keys(this.cohorts).forEach(cohortType => {
                        const cohort = this.cohorts[cohortType];
                        
                        const total = cohort.length;
                        const assessmentComplete = cohort.filter(u => 
                            u.journey.some(e => e.stage === 'assessment-complete')).length;
                        const waitlistJoined = cohort.filter(u => 
                            u.journey.some(e => e.stage === 'waitlist')).length;

                        
                        rates[cohortType] = {
                            total: total,
                            assessmentCompletionRate: total > 0 ? (assessmentComplete / total * 100).toFixed(2) : 0,
                            waitlistConversionRate: total > 0 ? (waitlistJoined / total * 100).toFixed(2) : 0,
                            paymentConversionRate: total > 0 ? (paymentCompleted / total * 100).toFixed(2) : 0,
                            assessmentToWaitlist: assessmentComplete > 0 ? (waitlistJoined / assessmentComplete * 100).toFixed(2) : 0,
                            waitlistToPayment: waitlistJoined > 0 ? (paymentCompleted / waitlistJoined * 100).toFixed(2) : 0
                        };
                    });
                    
                    return rates;
                } catch (error) {
                    ErrorHandler.logError('Conversion rate calculation error', error);
                    return {};
                }
            },
            
            getPerformanceMetrics: function() {
                try {
                    const rates = this.calculateConversionRates();
                    const assessmentQualified = rates['assessment-qualified'];
                    const directSignup = rates['direct-signup'];
                    
                    let qualificationImprovement = null;
                    if (assessmentQualified && directSignup && 
                        directSignup.paymentConversionRate > 0) {
                        qualificationImprovement = (
                            assessmentQualified.paymentConversionRate / directSignup.paymentConversionRate
                        ).toFixed(2);
                    }
                    
                    return {
                        conversionRates: rates,
                        qualificationImprovement: qualificationImprovement,
                        totalEvents: this.events.length,
                        activeCohorts: Object.keys(this.cohorts).filter(k => this.cohorts[k].length > 0)
                    };
                } catch (error) {
                    ErrorHandler.logError('Performance metrics calculation error', error);
                    return { error: 'Calculation failed' };
                }
            }
        };

        // =============================================================================
        // REPAIRED: EXIT-INTENT OPTIMIZATION SYSTEM
        // =============================================================================
        
        const ExitIntentManager = {
            isActive: false,
            hasShownIntent: false,
            mouseOutCount: 0,
            progressData: null,
            
            init: function() {
                this.setupExitIntentDetection();
                this.setupProgressSaving();
            },
            
            setupExitIntentDetection: function() {
                try {
                    // Mouse out detection
                    document.addEventListener('mouseleave', (e) => {
                        this.handleMouseLeave(e);
                    });
                    
                    // Before unload detection
                    window.addEventListener('beforeunload', (e) => {
                        this.handleBeforeUnload(e);
                    });
                    
                    // Visibility change detection
                    document.addEventListener('visibilitychange', () => {
                        if (document.hidden && this.shouldShowExitIntent()) {
                            this.showExitIntentModal();
                        }
                    });
                    
                    console.log('✅ Exit-intent detection initialized');
                } catch (error) {
                    ErrorHandler.logError('Exit-intent initialization error', error);
                }
            },
            
            handleMouseLeave: function(e) {
                if (e.clientY <= 0 && this.shouldShowExitIntent()) {
                    this.mouseOutCount++;
                    if (this.mouseOutCount >= 2) { // Show after second mouse-out
                        this.showExitIntentModal();
                    }
                }
            },
            
            handleBeforeUnload: function(e) {
                if (this.shouldShowExitIntent()) {
                    this.saveCurrentProgress();
                    e.preventDefault();
                    e.returnValue = 'You\'re partway through your assessment. Your progress will be saved.';
                    return e.returnValue;
                }
            },
            
            shouldShowExitIntent: function() {
                return assessmentState.currentStep === 2 && // On assessment page
                       !assessmentState.assessmentCompleted && // Assessment not completed
                       !this.hasShownIntent && // Haven't shown modal yet
                       HSAssessmentService.currentIndex > 2; // At least 3 questions answered
            },
            
            showExitIntentModal: function() {
                if (this.hasShownIntent) return;
                
                try {
                    this.hasShownIntent = true;
                    const progress = HSAssessmentService.getProgress();
                    const questionsLeft = progress.total - progress.current;
                    
                    const modal = this.createExitIntentModal(progress, questionsLeft);
                    document.body.appendChild(modal);
                    
                    // Track exit-intent event
                    CohortTracker.trackUserJourney(
                        assessmentState.sessionId,
                        'assessment-qualified',
                        'exit-intent',
                        { questionsAnswered: progress.current, questionsLeft: questionsLeft }
                    );
                    
                    console.log('🚨 Exit-intent modal shown');
                } catch (error) {
                    ErrorHandler.logError('Exit-intent modal error', error);
                }
            },
            
            createExitIntentModal: function(progress, questionsLeft) {
                const modal = document.createElement('div');
                modal.id = 'exit-intent-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    animation: fadeIn 0.3s ease-out;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: var(--color-background-secondary);
                        padding: var(--spacing-3xl);
                        border-radius: var(--border-radius-md);
                        max-width: 500px;
                        margin: var(--spacing-xl);
                        text-align: center;
                        border: 1px solid var(--color-surface);
                        position: relative;
                    ">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-lg);">⏰</div>
                        <h3 style="color: var(--color-text-primary); font-size: var(--font-size-2xl); margin-bottom: var(--spacing-md);">
                            You're ${progress.percentage}% Complete!
                        </h3>
                        <p style="color: var(--color-text-muted); margin-bottom: var(--spacing-xl); font-size: var(--font-size-base);">
                            Only ${questionsLeft} questions left to get your personalized revenue optimization analysis.
                        </p>
                        <div style="display: flex; gap: var(--spacing-lg); justify-content: center;">
                            <button onclick="ExitIntentManager.completeAssessment()" class="btn btn-primary" style="padding: var(--spacing-lg) var(--spacing-2xl);">
                                ✅ Complete Assessment (${questionsLeft} questions)
                            </button>
                            <button onclick="ExitIntentManager.saveAndExit()" class="btn btn-secondary" style="padding: var(--spacing-lg) var(--spacing-2xl);">
                                💾 Save & Exit
                            </button>
                        </div>
                        <button onclick="ExitIntentManager.closeModal()" style="
                            position: absolute;
                            top: var(--spacing-lg);
                            right: var(--spacing-lg);
                            background: none;
                            border: none;
                            color: var(--color-text-muted);
                            font-size: var(--font-size-xl);
                            cursor: pointer;
                            padding: var(--spacing-xs);
                        ">×</button>
                    </div>
                `;
                
                return modal;
            },
            
            completeAssessment: function() {
                this.closeModal();
                // Focus back on current question
                const nextBtn = DOMUtils.safeGetElement('next-question');
                if (nextBtn) nextBtn.focus();
            },
            
            saveAndExit: function() {
                this.saveCurrentProgress();
                this.scheduleFollowUpEmail();
                this.closeModal();
                
                ErrorHandler.showUserError('Progress saved! We\'ll email you a link to complete your assessment.', 'success');
                
                // Track save and exit
                CohortTracker.trackUserJourney(
                    assessmentState.sessionId,
                    'assessment-qualified',
                    'save-and-exit',
                    { questionsAnswered: HSAssessmentService.currentIndex }
                );
            },
            
            closeModal: function() {
                const modal = DOMUtils.safeGetElement('exit-intent-modal');
                if (modal) {
                    modal.remove();
                }
            },
            
            setupProgressSaving: function() {
                // Auto-save progress after each question
                const originalSaveResponse = HSAssessmentService.saveResponse;
                HSAssessmentService.saveResponse = function(questionId, value) {
                    const result = originalSaveResponse.call(this, questionId, value);
                    ExitIntentManager.saveCurrentProgress();
                    return result;
                };
            },
            
            saveCurrentProgress: function() {
                try {
                    this.progressData = {
                        userDetails: assessmentState.userDetails,
                        responses: HSAssessmentService.responses,
                        currentIndex: HSAssessmentService.currentIndex,
                        sessionId: assessmentState.sessionId,
                        savedAt: new Date().toISOString()
                    };
                    
                    // In production, this would be sent to your backend
                    console.log('💾 Progress saved:', this.progressData);
                } catch (error) {
                    ErrorHandler.logError('Progress saving error', error);
                }
            },
            
            scheduleFollowUpEmail: function() {
                try {
                    const followUpData = {
                        email: assessmentState.userDetails.email,
                        name: assessmentState.userDetails.productName || 'there',
                        questionsAnswered: HSAssessmentService.currentIndex,
                        questionsRemaining: HSAssessmentService.allQuestions.length - HSAssessmentService.currentIndex,
                        completionUrl: `${window.location.href}?resume=${assessmentState.sessionId}`,
                        scheduledFor: new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString() // 2 hours later
                    };
                    
                    // In production, this would trigger your email automation
                    console.log('📧 Follow-up email scheduled:', followUpData);
                } catch (error) {
                    ErrorHandler.logError('Follow-up email scheduling error', error);
                }
            }
        };

        // =============================================================================
        // REPAIRED: SOCIAL SHARING & LINKEDIN GRAPHICS SYSTEM
        // =============================================================================
        
        const SocialShareGenerator = {
            canvasCache: null,
            
            generateResultsGraphic: function(assessmentData) {
                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = 1200;
                    canvas.height = 630; // LinkedIn optimal size
                    const ctx = canvas.getContext('2d');
                    
                    // Background gradient
                    const gradient = ctx.createLinearGradient(0, 0, 1200, 630);
                    gradient.addColorStop(0, '#000000');
                    gradient.addColorStop(1, '#0f172a');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, 1200, 630);
                    
                    // Brand colors
                    const brandPrimary = '#06b6d4';
                    const brandSecondary = '#10b981';
                    const textPrimary = '#ffffff';
                    const textMuted = '#94a3b8';
                    
                    // Title
                    ctx.fillStyle = textPrimary;
                    ctx.font = 'bold 48px Red Hat Display, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('Revenue Performance Assessment', 600, 100);
                    
                    // Score circle
                    const centerX = 300;
                    const centerY = 300;
                    const radius = 120;
                    
                    // Background circle
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                    ctx.strokeStyle = '#334155';
                    ctx.lineWidth = 8;
                    ctx.stroke();
                    
                    // Score arc
                    const scoreAngle = (assessmentData.score / 100) * 2 * Math.PI;
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, -Math.PI/2, -Math.PI/2 + scoreAngle);
                    ctx.strokeStyle = brandPrimary;
                    ctx.lineWidth = 8;
                    ctx.stroke();
                    
                    // Score text
                    ctx.fillStyle = brandPrimary;
                    ctx.font = 'bold 72px Red Hat Display, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(assessmentData.score, centerX, centerY + 10);
                    
                    ctx.fillStyle = textMuted;
                    ctx.font = '24px Red Hat Display, sans-serif';
                    ctx.fillText('/100', centerX, centerY + 45);
                    
                    // Metrics
                    const metrics = [
                        { label: 'Challenges Identified', value: assessmentData.challenges },
                        { label: 'Risk Level', value: assessmentData.riskLevel },
                        { label: 'Focus Area', value: assessmentData.focusArea }
                    ];
                    
                    let yPos = 200;
                    metrics.forEach(metric => {
                        ctx.fillStyle = textMuted;
                        ctx.font = '20px Red Hat Display, sans-serif';
                        ctx.textAlign = 'left';
                        ctx.fillText(metric.label, 600, yPos);
                        
                        ctx.fillStyle = textPrimary;
                        ctx.font = 'bold 32px Red Hat Display, sans-serif';
                        ctx.fillText(metric.value, 600, yPos + 35);
                        
                        yPos += 80;
                    });
                    
                    // Footer
                    ctx.fillStyle = textMuted;
                    ctx.font = '18px Red Hat Display, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('H&S Revenue Optimization • Systematic Sales for Technical Founders', 600, 580);
                    
                    this.canvasCache = canvas;
                    return canvas.toDataURL('image/png');
                    
                } catch (error) {
                    ErrorHandler.logError('Results graphic generation error', error);
                    return null;
                }
            },
            
            createLinkedInPost: function(assessmentData) {
                try {
                    const posts = {
                        high_score: `🎯 Just completed a comprehensive revenue performance assessment and scored ${assessmentData.score}/100!

Key insights:
• ${assessmentData.challenges} optimization opportunities identified
• Focus area: ${assessmentData.focusArea}
• Revenue potential: ${assessmentData.revenueOpportunity}

The systematic approach to sales methodology really resonates with my technical background. Finally, a sales framework that makes sense for founders who think in systems.

#TechnicalFounders #RevenueOptimization #B2BSales #SalesEngineering`,

                        medium_score: `📊 Interesting results from a revenue performance assessment: ${assessmentData.score}/100

Areas for improvement:
• ${assessmentData.challenges} specific challenges identified  
• Primary focus: ${assessmentData.focusArea}
• Risk level: ${assessmentData.riskLevel}

As a technical founder, I appreciate the systematic approach to identifying exactly where my sales process needs work. Much better than generic sales advice.

#FounderJourney #RevenueGrowth #SalesOptimization #TechnicalFounders`,

                        low_score: `🔍 Eye-opening assessment results: ${assessmentData.score}/100 revenue performance score

Key findings:
• ${assessmentData.challenges} critical areas need attention
• ${assessmentData.riskLevel} risk level identified
• Focus area: ${assessmentData.focusArea}

Sometimes you need data to show you what you already suspected. Time to systematically address these gaps instead of hoping they'll fix themselves.

#FounderReality #RevenueOptimization #SalesImprovement #SystematicApproach`
                    };
                    
                    let postType = 'medium_score';
                    if (assessmentData.score >= 70) postType = 'high_score';
                    if (assessmentData.score < 45) postType = 'low_score';
                    
                    return {
                        text: posts[postType],
                        hashtags: ['TechnicalFounders', 'RevenueOptimization', 'B2BSales', 'SalesEngineering'],
                        graphic: this.generateResultsGraphic(assessmentData)
                    };
                    
                } catch (error) {
                    ErrorHandler.logError('LinkedIn post creation error', error);
                    return null;
                }
            },
            
            showSharingModal: function(assessmentData) {
                try {
                    const linkedInPost = this.createLinkedInPost(assessmentData);
                    if (!linkedInPost) return;
                    
                    const modal = document.createElement('div');
                    modal.id = 'social-sharing-modal';
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        animation: fadeIn 0.3s ease-out;
                    `;
                    
                    modal.innerHTML = `
                        <div style="
                            background: var(--color-background-secondary);
                            padding: var(--spacing-3xl);
                            border-radius: var(--border-radius-md);
                            max-width: 600px;
                            max-height: 80vh;
                            overflow-y: auto;
                            margin: var(--spacing-xl);
                            border: 1px solid var(--color-surface);
                            position: relative;
                        ">
                            <h3 style="color: var(--color-text-primary); font-size: var(--font-size-2xl); margin-bottom: var(--spacing-lg); text-align: center;">
                                📱 Share Your Assessment Results
                            </h3>
                            
                            <div style="margin-bottom: var(--spacing-xl);">
                                <img src="${linkedInPost.graphic}" style="width: 100%; border-radius: var(--border-radius-sm); margin-bottom: var(--spacing-lg);" alt="Assessment Results">
                            </div>
                            
                            <div style="margin-bottom: var(--spacing-xl);">
                                <label style="display: block; color: var(--color-text-primary); font-weight: 500; margin-bottom: var(--spacing-sm);">LinkedIn Post:</label>
                                <textarea readonly style="
                                    width: 100%;
                                    height: 200px;
                                    padding: var(--spacing-md);
                                    border: 1px solid var(--color-surface);
                                    border-radius: var(--border-radius-sm);
                                    background: var(--color-background-tertiary);
                                    color: var(--color-text-secondary);
                                    font-size: var(--font-size-sm);
                                    line-height: 1.5;
                                    resize: vertical;
                                " id="linkedin-post-text">${linkedInPost.text}</textarea>
                            </div>
                            
                            <div style="display: flex; gap: var(--spacing-lg); justify-content: center; flex-wrap: wrap;">
                                <button onclick="SocialShareGenerator.shareToLinkedIn('${encodeURIComponent(linkedInPost.text)}')" class="btn btn-primary">
                                    🔗 Share on LinkedIn
                                </button>
                                <button onclick="SocialShareGenerator.copyPost()" class="btn btn-secondary">
                                    📋 Copy Post
                                </button>
                                <button onclick="SocialShareGenerator.downloadGraphic()" class="btn btn-secondary">
                                    💾 Download Image
                                </button>
                            </div>
                            
                            <button onclick="SocialShareGenerator.closeSharingModal()" style="
                                position: absolute;
                                top: var(--spacing-lg);
                                right: var(--spacing-lg);
                                background: none;
                                border: none;
                                color: var(--color-text-muted);
                                font-size: var(--font-size-xl);
                                cursor: pointer;
                                padding: var(--spacing-xs);
                            ">×</button>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Track social sharing view
                    CohortTracker.trackUserJourney(
                        assessmentState.sessionId,
                        'assessment-qualified',
                        'social-share-view',
                        { score: assessmentData.score, challenges: assessmentData.challenges }
                    );
                    
                } catch (error) {
                    ErrorHandler.logError('Sharing modal error', error);
                }
            },
            
            shareToLinkedIn: function(postText) {
                try {
                    const linkedInUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}&summary=${postText}`;
                    window.open(linkedInUrl, '_blank', 'width=600,height=600');
                    
                    // Track social sharing
                    CohortTracker.trackUserJourney(
                        assessmentState.sessionId,
                        'assessment-qualified',
                        'social-share-linkedin',
                        { platform: 'linkedin' }
                    );
                    
                    this.closeSharingModal();
                } catch (error) {
                    ErrorHandler.logError('LinkedIn sharing error', error);
                }
            },
            
            copyPost: function() {
                try {
                    const postText = document.getElementById('linkedin-post-text');
                    postText.select();
                    document.execCommand('copy');
                    
                    ErrorHandler.showUserError('Post copied to clipboard!', 'success');
                    
                    // Track copy action
                    CohortTracker.trackUserJourney(
                        assessmentState.sessionId,
                        'assessment-qualified',
                        'social-share-copy',
                        { action: 'copy-post' }
                    );
                    
                } catch (error) {
                    ErrorHandler.logError('Copy post error', error);
                }
            },
            
            downloadGraphic: function() {
                try {
                    if (!this.canvasCache) return;
                    
                    const link = document.createElement('a');
                    link.download = `revenue-assessment-${assessmentState.sessionId}.png`;
                    link.href = this.canvasCache.toDataURL();
                    link.click();
                    
                    // Track download action
                    CohortTracker.trackUserJourney(
                        assessmentState.sessionId,
                        'assessment-qualified',
                        'social-share-download',
                        { action: 'download-graphic' }
                    );
                    
                } catch (error) {
                    ErrorHandler.logError('Graphic download error', error);
                }
            },
            
            closeSharingModal: function() {
                const modal = DOMUtils.safeGetElement('social-sharing-modal');
                if (modal) {
                    modal.remove();
                }
            },
            
            trackSocialSharing: function(platform, assessmentData) {
                try {
                    CohortTracker.trackUserJourney(
                        assessmentState.sessionId,
                        'assessment-qualified',
                        'social-shared',
                        { 
                            platform: platform,
                            score: assessmentData.score,
                            challenges: assessmentData.challenges,
                            riskLevel: assessmentData.riskLevel
                        }
                    );
                } catch (error) {
                    ErrorHandler.logError('Social sharing tracking error', error);
                }
            }
        };
        
        const DOMUtils = {
            safeGetElement: function(id, context = document) {
                try {
                    const element = context.getElementById ? context.getElementById(id) : context.querySelector(`#${id}`);
                    if (!element) {
                        console.warn(`⚠️ Element not found: ${id}`);
                        return null;
                    }
                    return element;
                } catch (error) {
                    console.error(`❌ Error getting element ${id}:`, error);
                    return null;
                }
            },
            
            safeSetContent: function(id, content, type = 'innerHTML') {
                const element = this.safeGetElement(id);
                if (!element) return false;
                
                try {
                    if (type === 'text') {
                        element.textContent = content;
                    } else {
                        element.innerHTML = content;
                    }
                    return true;
                } catch (error) {
                    console.error(`❌ Error setting content for ${id}:`, error);
                    return false;
                }
            },
            
            safeAddEventListener: function(id, event, handler, options = {}) {
                const element = this.safeGetElement(id);
                if (!element) return false;
                
                try {
                    const wrappedHandler = function(...args) {
                        try {
                            return handler.apply(this, args);
                        } catch (error) {
                            ErrorHandler.logError('Event handler error', error, { elementId: id, event });
                            return false;
                        }
                    };
                    
                    element.addEventListener(event, wrappedHandler, options);
                    console.log(`✅ Event listener attached: ${id} -> ${event}`);
                    return true;
                } catch (error) {
                    console.error(`❌ Error adding event listener to ${id}:`, error);
                    return false;
                }
            },
            
            safeToggleClass: function(id, className, force = null) {
                const element = this.safeGetElement(id);
                if (!element) return false;
                
                try {
                    if (force !== null) {
                        element.classList.toggle(className, force);
                    } else {
                        element.classList.toggle(className);
                    }
                    return true;
                } catch (error) {
                    console.error(`❌ Error toggling class ${className} on ${id}:`, error);
                    return false;
                }
            }
        };

        // =============================================================================
        // ASSESSMENT LINKEDIN SHARING FUNCTION
        // =============================================================================
        
        function shareAssessmentToLinkedIn() {
            try {
                // Get assessment results from global state
                const results = assessmentState.analysisResults;
                const userDetails = assessmentState.userDetails;
                
                if (!results || !userDetails) {
                    throw new Error('Assessment results not found');
                }
                
                // Create personalized LinkedIn post based on assessment results
                const score = results.overall.score;
                const productName = userDetails.productName || 'my product';
                const challenges = results.challenges?.length || 0;
                
                let postText = '';
                
                if (score >= 70) {
                    postText = `🎯 Just completed a comprehensive buyer intelligence assessment for ${productName}! \\n\\nScore: ${score}/100 - Strong foundation in place! \\n\\n🚀 Key insight: Having clear buyer understanding and technical value translation puts us in the top tier for B2B success. \\n\\n#B2B #TechnicalFounders #BuyerIntelligence #ProductStrategy`;
                } else if (score >= 50) {
                    postText = `💡 Valuable insights from completing a buyer intelligence assessment for ${productName}! \\n\\nScore: ${score}/100 - Clear action plan ahead \\n\\n🎯 Identified ${challenges} key areas for improvement in buyer understanding and value communication. \\n\\nEvery technical founder's journey includes these growth opportunities! \\n\\n#B2B #TechnicalFounders #ProductStrategy #ContinuousImprovement`;
                } else {
                    postText = `🔍 Just completed an honest assessment of ${productName}'s buyer intelligence! \\n\\nScore: ${score}/100 - Ready to level up! \\n\\n💪 Identified ${challenges} specific growth areas. The best part? Now I have a clear roadmap for improvement. \\n\\nEvery successful technical founder started somewhere! \\n\\n#B2B #TechnicalFounders #Growth #ProductStrategy`;
                }
                
                // Add call to action
                postText += `\\n\\n🔗 Technical founders can take the assessment at: ${window.location.origin}`;
                
                // Use existing LinkedIn sharing function
                SocialShareGenerator.shareToLinkedIn(encodeURIComponent(postText));
                
                // Track the sharing action
                if (typeof CohortTracker !== 'undefined') {
                    CohortTracker.trackUserJourney(
                        assessmentState.sessionId,
                        'assessment-complete', 
                        'linkedin-share',
                        { 
                            score: score,
                            productName: productName,
                            challenges: challenges
                        }
                    );
                }
                
            } catch (error) {
                console.error('LinkedIn sharing error:', error);
                
                // Fallback: generic sharing
                const fallbackText = `🎯 Just completed a comprehensive B2B buyer intelligence assessment! \\n\\nGreat insights for technical founders looking to improve their sales and market positioning. \\n\\n#B2B #TechnicalFounders #ProductStrategy \\n\\n🔗 Take the assessment: ${window.location.origin}`;
                
                SocialShareGenerator.shareToLinkedIn(encodeURIComponent(fallbackText));
            }
        }

        // =============================================================================
        // REPAIRED: CENTRALIZED ERROR HANDLING
        // =============================================================================
        
        const ErrorHandler = {
            logError: function(message, error, context = {}) {
                const errorInfo = {
                    message,
                    error: error?.message || error,
                    stack: error?.stack,
                    context,
                    timestamp: new Date().toISOString(),
                    sessionId: assessmentState.sessionId
                };
                
                console.error('❌ Application Error:', errorInfo);
                assessmentState.errors.push(errorInfo);
                assessmentState.lastError = errorInfo;
                
                this.showUserError(message);
                return errorInfo;
            },
            
            showUserError: function(message, type = 'error') {
                const className = type === 'error' ? 'error-message' : 'success-message';
                const icon = type === 'error' ? '❌' : '✅';
                
                let errorElement = DOMUtils.safeGetElement('user-error-display');
                if (!errorElement) {
                    errorElement = document.createElement('div');
                    errorElement.id = 'user-error-display';
                    errorElement.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        max-width: 400px;
                        z-index: 10000;
                        opacity: 0;
                        transform: translateX(100%);
                        transition: all 0.3s ease;
                    `;
                    document.body.appendChild(errorElement);
                }
                
                errorElement.className = className;
                errorElement.innerHTML = `${icon} ${message}`;
                
                setTimeout(() => {
                    errorElement.style.opacity = '1';
                    errorElement.style.transform = 'translateX(0)';
                }, 10);
                
                setTimeout(() => {
                    errorElement.style.opacity = '0';
                    errorElement.style.transform = 'translateX(100%)';
                }, 5000);
            },
            
            handleCriticalError: function(message, error, recovery = null) {
                this.logError(message, error);
                
                const errorContainer = DOMUtils.safeGetElement('error-container');
                const errorMessage = DOMUtils.safeGetElement('error-message');
                
                if (errorContainer && errorMessage) {
                    DOMUtils.safeSetContent('error-message', `${message}: ${error?.message || error}`);
                    DOMUtils.safeToggleClass('error-container', 'hidden', false);
                    
                    ['landing-section', 'user-details-section', 'assessment-section', 'analytics-section', 
                     'challenges-section', 'recommendations-section'].forEach(id => {
                        DOMUtils.safeToggleClass(id, 'hidden', true);
                    });
                }
                
                if (recovery && typeof recovery === 'function') {
                    setTimeout(recovery, 2000);
                }
            }
        };

        // =============================================================================
        // REPAIRED: ENHANCED LOADING MANAGER
        // =============================================================================
        
        const LoadingManager = {
            sequence: [
                { time: 0, progress: 0, status: "Initializing assessment services..." },
                { time: 800, progress: 25, status: "Loading buyer intelligence framework..." },
                { time: 1600, progress: 50, status: "Preparing analytics engine..." },
                { time: 2400, progress: 75, status: "Configuring recommendation system..." },
                { time: 3200, progress: 95, status: "Finalizing revenue optimization tools..." },
                { time: 4000, progress: 100, status: "Assessment ready! 🎯" }
            ],
            
            start: function() {
                console.log('🚀 LoadingManager: Starting sequence');
                
                try {
                    const elements = {
                        progressBar: DOMUtils.safeGetElement('loading-progress'),
                        statusText: DOMUtils.safeGetElement('loading-status'),
                        loadingScreen: DOMUtils.safeGetElement('hs-assessment-loading'),
                        mainContainer: DOMUtils.safeGetElement('main-assessment-container')
                    };
                    
                    if (!elements.loadingScreen || !elements.mainContainer) {
                        throw new Error('Critical loading elements not found');
                    }
                    
                    this.sequence.forEach((step, index) => {
                        setTimeout(() => {
                            try {
                                if (elements.progressBar) {
                                    elements.progressBar.style.width = step.progress + '%';
                                }
                                
                                if (elements.statusText) {
                                    elements.statusText.style.opacity = '0';
                                    setTimeout(() => {
                                        elements.statusText.textContent = step.status;
                                        elements.statusText.style.opacity = '1';
                                    }, 150);
                                }
                                
                                if (index === this.sequence.length - 1) {
                                    setTimeout(() => this.complete(elements), 500);
                                }
                            } catch (error) {
                                ErrorHandler.logError('Loading sequence step error', error);
                            }
                        }, step.time);
                    });
                    
                } catch (error) {
                    ErrorHandler.handleCriticalError('Loading initialization failed', error, () => {
                        const mainContainer = DOMUtils.safeGetElement('main-assessment-container');
                        const loadingScreen = DOMUtils.safeGetElement('hs-assessment-loading');
                        
                        if (loadingScreen) loadingScreen.style.display = 'none';
                        if (mainContainer) mainContainer.style.opacity = '1';
                        
                        initializeComponent1();
                    });
                }
            },
            
            complete: function(elements) {
                console.log('🎉 LoadingManager: Completing sequence');
                
                try {
                    if (elements.loadingScreen) {
                        elements.loadingScreen.classList.add('fade-out');
                        setTimeout(() => {
                            elements.loadingScreen.style.display = 'none';
                        }, 500);
                    }
                    
                    if (elements.mainContainer) {
                        elements.mainContainer.style.opacity = '1';
                    }
                    
                    assessmentState.loadingCompleted = true;
                    assessmentState.initialized = true;
                    
                    setTimeout(() => {
                        initializeComponent1();
                    }, 600);
                    
                } catch (error) {
                    ErrorHandler.handleCriticalError('Loading completion failed', error);
                }
            }
        };

        // =============================================================================
        // REPAIRED: ENHANCED ASSESSMENT SERVICE WITH COMPLETE QUESTIONS
        // =============================================================================
        
        const HSAssessmentService = {
            allQuestions: [
                {
                    id: "conversationConfidence",
                    category: "Buyer Understanding",
                    categoryWeight: "60%",
                    type: "scale",
                    order: 1,
                    title: "How confident are you in your ability to have productive conversations with your ideal customers?",
                    help: "Consider your comfort level discussing their business challenges, goals, and how your solution fits their needs.",
                    labels: ["Not confident at all", "Extremely confident"]
                },
                {
                    id: "valuePropositionSpecificity",
                    category: "Buyer Understanding", 
                    categoryWeight: "60%",
                    type: "scale",
                    order: 2,
                    title: "How specific can you be about the value your product creates for different customer segments?",
                    help: "Can you articulate concrete, measurable benefits for different types of users or use cases?",
                    labels: ["Very vague/generic", "Extremely specific"]
                },
                {
                    id: "objectionPredictability",
                    category: "Buyer Understanding",
                    categoryWeight: "60%", 
                    type: "choice",
                    order: 3,
                    title: "Can you predict the most common objections prospects will raise?",
                    help: "Think about whether you can anticipate what concerns or hesitations potential customers typically have.",
                    options: [
                        { value: "yes", text: "Yes, I can predict the most common objections" },
                        { value: "no", text: "No, objections often surprise me" }
                    ]
                },
                {
                    id: "stakeholderAwareness",
                    category: "Buyer Understanding",
                    categoryWeight: "60%",
                    type: "choice", 
                    order: 4,
                    title: "How many different stakeholders are typically involved in your customers' buying decisions?",
                    help: "Consider all the people who might influence or approve the purchase decision.",
                    options: [
                        { value: "not-sure", text: "I'm not sure" },
                        { value: "1-2", text: "1-2 people" },
                        { value: "3-4", text: "3-4 people" },
                        { value: "5+", text: "5 or more people" }
                    ]
                },
                {
                    id: "buyerJourneyUnderstanding",
                    category: "Buyer Understanding",
                    categoryWeight: "60%",
                    type: "choice",
                    order: 5,
                    title: "Do you understand the typical steps your prospects go through before making a purchase decision?",
                    help: "This includes their research process, evaluation criteria, and decision-making timeline.",
                    options: [
                        { value: "yes", text: "Yes, I understand their buying journey well" },
                        { value: "no", text: "No, their buying process is unclear to me" }
                    ]
                },
                {
                    id: "championIdentification",
                    category: "Buyer Understanding",
                    categoryWeight: "60%",
                    type: "choice",
                    order: 6,
                    title: "How often do you identify a strong internal champion during your sales process?",
                    help: "A champion is someone inside the prospect's organization who actively advocates for your solution.",
                    options: [
                        { value: "not-sure", text: "I'm not sure what this means" },
                        { value: "some", text: "Sometimes, but not consistently" },
                        { value: "most", text: "Most of the time" },
                        { value: "all", text: "Nearly every qualified opportunity" }
                    ]
                },
                {
                    id: "referenceComfortLevel",
                    category: "Buyer Understanding",
                    categoryWeight: "60%",
                    type: "scale",
                    order: 7,
                    title: "How comfortable would your existing customers be serving as references for prospects?",
                    help: "Consider whether customers would willingly speak with prospects about their positive experience.",
                    labels: ["Not comfortable at all", "Extremely comfortable"]
                },
                {
                    id: "industrySpecificValue",
                    category: "Buyer Understanding",
                    categoryWeight: "60%", 
                    type: "scale",
                    order: 8,
                    title: "How well can you articulate industry-specific value propositions?",
                    help: "Can you customize your value proposition for different industries or verticals?",
                    labels: ["One-size-fits-all approach", "Highly customized per industry"]
                },
                {
                    id: "featureTranslationAbility",
                    category: "Tech-to-Value Translation",
                    categoryWeight: "40%",
                    type: "scale",
                    order: 9,
                    title: "How effectively can you translate technical features into business benefits?",
                    help: "Can you explain what your technical capabilities mean in terms of business outcomes?",
                    labels: ["Focus mainly on features", "Focus entirely on business impact"]
                },
                {
                    id: "technicalObjectionFrequency",
                    category: "Tech-to-Value Translation",
                    categoryWeight: "40%",
                    type: "scale",
                    order: 10,
                    title: "How often do prospects get lost in technical discussions during your presentations?",
                    help: "Consider whether prospects disengage when you explain technical aspects of your solution.",
                    labels: ["Never get lost", "Always get lost"]
                },
                {
                    id: "competitiveDifferentiation",
                    category: "Tech-to-Value Translation",
                    categoryWeight: "40%",
                    type: "scale",
                    order: 11,
                    title: "How clearly can you differentiate your technical approach from competitors?",
                    help: "Can you explain why your technical choices create superior business outcomes?",
                    labels: ["Very unclear differentiation", "Crystal clear differentiation"]
                },
                {
                    id: "businessCaseCreation",
                    category: "Tech-to-Value Translation",
                    categoryWeight: "40%",
                    type: "choice",
                    order: 12,
                    title: "Can you help prospects build a compelling business case for your solution?",
                    help: "This means helping them quantify ROI, cost savings, or revenue impact.",
                    options: [
                        { value: "yes", text: "Yes, I can help build strong business cases" },
                        { value: "no", text: "No, I struggle with business case development" }
                    ]
                },
                {
                    id: "successMetricClarity",
                    category: "Tech-to-Value Translation",
                    categoryWeight: "40%",
                    type: "scale",
                    order: 13,
                    title: "How clearly can you define what success looks like for customers using your solution?",
                    help: "Can you specify measurable outcomes and success metrics?",
                    labels: ["Very vague success metrics", "Extremely clear success metrics"]
                },
                {
                    id: "executiveReadiness",
                    category: "Tech-to-Value Translation",
                    categoryWeight: "40%",
                    type: "choice",
                    order: 14,
                    title: "Are you comfortable presenting to executive-level decision makers?",
                    help: "Consider your ability to communicate value at the C-level without getting too technical.",
                    options: [
                        { value: "yes", text: "Yes, I'm comfortable with executive presentations" },
                        { value: "no", text: "No, I prefer technical audiences" }
                    ]
                }
            ],
            
            currentIndex: 0,
            responses: {},
            
            getCurrentQuestion: function() {
                try {
                    if (this.currentIndex >= this.allQuestions.length) {
                        return { completed: true, question: null };
                    }
                    
                    return {
                        completed: false,
                        question: this.allQuestions[this.currentIndex]
                    };
                } catch (error) {
                    ErrorHandler.logError('Error getting current question', error);
                    return { completed: true, question: null, error: true };
                }
            },
            
            getProgress: function() {
                try {
                    return {
                        current: this.currentIndex,
                        total: this.allQuestions.length,
                        percentage: Math.round((this.currentIndex / this.allQuestions.length) * 100)
                    };
                } catch (error) {
                    ErrorHandler.logError('Error calculating progress', error);
                    return { current: 0, total: 14, percentage: 0 };
                }
            },
            
            saveResponse: function(questionId, value) {
                try {
                    if (!questionId || value === undefined || value === null) {
                        throw new Error('Invalid question ID or value');
                    }
                    
                    this.responses[questionId] = value;
                    console.log(`💾 Saved response: ${questionId} = ${value}`);
                    return { success: true };
                } catch (error) {
                    ErrorHandler.logError('Error saving response', error, { questionId, value });
                    return { success: false, error: error.message };
                }
            },
            
            nextQuestion: function() {
                try {
                    if (this.currentIndex < this.allQuestions.length - 1) {
                        this.currentIndex++;
                        return this.getCurrentQuestion();
                    } else {
                        return { completed: true, question: null };
                    }
                } catch (error) {
                    ErrorHandler.logError('Error advancing to next question', error);
                    return { completed: true, question: null, error: true };
                }
            },
            
            previousQuestion: function() {
                try {
                    if (this.currentIndex > 0) {
                        this.currentIndex--;
                    }
                    return this.getCurrentQuestion();
                } catch (error) {
                    ErrorHandler.logError('Error going to previous question', error);
                    return this.getCurrentQuestion();
                }
            },
            
            getAllResponses: function() {
                try {
                    return {
                        responses: this.responses,
                        completionRate: (Object.keys(this.responses).length / this.allQuestions.length) * 100,
                        totalQuestions: this.allQuestions.length,
                        answeredQuestions: Object.keys(this.responses).length
                    };
                } catch (error) {
                    ErrorHandler.logError('Error getting all responses', error);
                    return {
                        responses: {},
                        completionRate: 0,
                        totalQuestions: 14,
                        answeredQuestions: 0
                    };
                }
            }
        };

        window.HSAssessmentService = HSAssessmentService;

        // =============================================================================
        // REPAIRED: NAVIGATION AND UI FUNCTIONS
        // =============================================================================
        
        // Landing page function
        function startFromLanding() {
            try {
                // Hide landing section and show user details
                DOMUtils.safeToggleClass('landing-section', 'hidden', true);
                DOMUtils.safeToggleClass('user-details-section', 'hidden', false);
                
                // Show progress steps
                const progressSteps = document.querySelector('.assessment-steps');
                if (progressSteps) {
                    progressSteps.classList.remove('hidden');
                }
                
                // Update assessment state
                assessmentState.currentStep = 1;
                
                // Update progress indicators
                updateProgressIndicators(1);
                
                console.log('✅ Started from landing page');
                
            } catch (error) {
                ErrorHandler.logError('Error starting from landing', error);
            }
        }

        function showStep(stepNumber) {
            console.log(`🔄 Navigating to step ${stepNumber}`);
            
            try {
                if (!stepNumber || stepNumber < 1 || stepNumber > 5) {
                    throw new Error(`Invalid step number: ${stepNumber}`);
                }
                
                const sections = ['landing-section', 'user-details-section', 'assessment-section', 'analytics-section', 
                                'challenges-section', 'recommendations-section'];
                
                sections.forEach(sectionId => {
                    DOMUtils.safeToggleClass(sectionId, 'hidden', true);
                });
                
                const targetSections = {
                    0: 'landing-section',
                    1: 'user-details-section',
                    2: 'assessment-section',
                    3: 'analytics-section',
                    4: 'challenges-section',
                    5: 'recommendations-section'
                };
                
                if (targetSections[stepNumber]) {
                    setTimeout(() => {
                        DOMUtils.safeToggleClass(targetSections[stepNumber], 'hidden', false);
                        
                        if (stepNumber === 4 && !assessmentState.challengesCompleted) {
                            handleChallengeDetection();
                        }
                        
                        if (stepNumber === 5 && !assessmentState.recommendationsCompleted) {
                            handleRecommendationsGeneration();
                        }
                        
                    }, 200);
                }
                
                updateStepIndicators(stepNumber);
                assessmentState.currentStep = stepNumber;
                
                console.log(`✅ Successfully navigated to step ${stepNumber}`);
                
            } catch (error) {
                ErrorHandler.logError('Navigation error', error, { stepNumber });
            }
        }
        
        function updateStepIndicators(currentStep) {
            try {
                document.querySelectorAll('.step').forEach((step, index) => {
                    const stepNum = index + 1;
                    step.classList.remove('active', 'completed');
                    
                    if (stepNum < currentStep) {
                        step.classList.add('completed');
                    } else if (stepNum === currentStep) {
                        step.classList.add('active');
                    }
                });
            } catch (error) {
                ErrorHandler.logError('Error updating step indicators', error, { currentStep });
            }
        }
        
        // =============================================================================
        // REPAIRED: FORM VALIDATION
        // =============================================================================
        
        function validateForm(formId) {
            try {
                const form = DOMUtils.safeGetElement(formId);
                if (!form) {
                    throw new Error(`Form not found: ${formId}`);
                }
                
                const requiredFields = form.querySelectorAll('[required]');
                let isValid = true;
                let firstErrorField = null;
                
                requiredFields.forEach(field => {
                    const value = field.value?.trim() || '';
                    
                    if (value === '') {
                        field.style.borderColor = 'var(--color-accent-danger)';
                        isValid = false;
                        if (!firstErrorField) firstErrorField = field;
                    } else {
                        field.style.borderColor = 'var(--color-brand-secondary)';
                        setTimeout(() => {
                            field.style.borderColor = 'var(--color-surface)';
                        }, 2000);
                    }
                });
                
                if (!isValid && firstErrorField) {
                    firstErrorField.focus();
                }
                
                return isValid;
                
            } catch (error) {
                ErrorHandler.logError('Form validation error', error, { formId });
                return false;
            }
        }
        
        function isValidEmail(email) {
            try {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            } catch (error) {
                ErrorHandler.logError('Email validation error', error);
                return false;
            }
        }
        
        function showValidationMessage(message, type = 'error') {
            try {
                ErrorHandler.showUserError(message, type);
            } catch (error) {
                console.error('Error showing validation message:', error);
                alert(message);
            }
        }

        // =============================================================================
        // REPAIRED: ASSESSMENT FLOW FUNCTIONS
        // =============================================================================
        
        function handleStartAssessment() {
            console.log('🚀 Starting assessment');
            
            try {
                if (!validateForm('user-details-form')) {
                    showValidationMessage('Please fill in all required fields to continue.');
                    return;
                }
                
                const email = DOMUtils.safeGetElement('email')?.value?.trim();
                if (!email || !isValidEmail(email)) {
                    showValidationMessage('Please enter a valid email address.');
                    return;
                }
                
                assessmentState.userDetails = {
                    email: email,
                    productName: DOMUtils.safeGetElement('productName')?.value?.trim() || '',
                    businessModel: DOMUtils.safeGetElement('businessModel')?.value || '',
                    productDescription: DOMUtils.safeGetElement('productDescription')?.value?.trim() || '',
                    distinguishingFeature: DOMUtils.safeGetElement('distinguishingFeature')?.value?.trim() || '',
                    customerCount: DOMUtils.safeGetElement('customerCount')?.value || '',
                    submittedAt: new Date().toISOString()
                };
                
                const requiredFields = ['email', 'productName', 'businessModel', 'productDescription', 'distinguishingFeature', 'customerCount'];
                const missingFields = requiredFields.filter(field => !assessmentState.userDetails[field]);
                
                if (missingFields.length > 0) {
                    throw new Error(`Missing required fields: ${missingFields.join(', ')}`);
                }
                
                // Track assessment start
                assessmentState.assessmentStartTime = Date.now();
                CohortTracker.trackUserJourney(
                    assessmentState.sessionId,
                    'assessment-qualified',
                    'assessment-start',
                    {
                        businessModel: assessmentState.userDetails.businessModel,
                        customerCount: assessmentState.userDetails.customerCount,
                        email: assessmentState.userDetails.email
                    }
                );
                
                DOMUtils.safeToggleClass('user-loading', 'hidden', false);
                
                setTimeout(() => {
                    DOMUtils.safeToggleClass('user-loading', 'hidden', true);
                    showStep(2);
                    startAssessmentQuestions();
                }, 800);
                
            } catch (error) {
                ErrorHandler.logError('Error starting assessment', error);
                showValidationMessage('Failed to start assessment. Please try again.');
            }
        }
        
        function startAssessmentQuestions() {
            console.log('📋 Starting assessment questions');
            
            try {
                DOMUtils.safeToggleClass('assessment-navigation', 'hidden', false);
                displayCurrentQuestion();
                updateProgress();
                
                // Track first question display
                CohortTracker.trackUserJourney(
                    assessmentState.sessionId,
                    'assessment-qualified',
                    'first-question-displayed',
                    { questionId: HSAssessmentService.getCurrentQuestion().question?.id }
                );
                
            } catch (error) {
                ErrorHandler.logError('Error starting assessment questions', error);
            }
        }
        
        function displayCurrentQuestion() {
            try {
                const questionData = HSAssessmentService.getCurrentQuestion();
                
                if (questionData.error) {
                    throw new Error('Error getting current question');
                }
                
                if (questionData.completed) {
                    console.log('Assessment completed');
                    return;
                }
                
                const question = questionData.question;
                assessmentState.currentQuestion = question;
                
                if (!DOMUtils.safeSetContent('question-container', generateQuestionHTML(question))) {
                    throw new Error('Failed to display question');
                }
                
                const nextBtn = DOMUtils.safeGetElement('next-question');
                if (nextBtn) nextBtn.disabled = false;
                
            } catch (error) {
                ErrorHandler.logError('Error displaying question', error);
            }
        }
        
        function generateQuestionHTML(question) {
            try {
                let questionHTML = `
                    <div class="question-container">
                        <div class="question-category">${question.category} (${question.categoryWeight})</div>
                        <div class="question-title">${question.title}</div>
                        <div class="question-help">${question.help}</div>
                        <div class="question-number">Question ${question.order} of 14</div>
                `;
                
                if (question.type === 'scale') {
                    questionHTML += `
                        <div class="scale-container">
                            <input type="range" 
                                   class="scale-input" 
                                   id="question-response"
                                   min="1" 
                                   max="10" 
                                   value="5"
                                   oninput="updateScaleValue(this.value)">
                            <div class="scale-value" id="scale-value">5</div>
                        </div>
                        <div class="scale-labels">
                            <span>${question.labels[0]}</span>
                            <span>${question.labels[1]}</span>
                        </div>
                    `;
                } else {
                    questionHTML += '<div class="radio-group">';
                    question.options.forEach((option, index) => {
                        questionHTML += `
                            <div class="radio-option" onclick="selectRadioOption('${option.value}', this)">
                                <input type="radio" 
                                       name="question-response" 
                                       value="${option.value}" 
                                       id="option-${index}"
                                       class="radio-input">
                                <div class="radio-text">${option.text}</div>
                            </div>
                        `;
                    });
                    questionHTML += '</div>';
                }
                
                questionHTML += '</div>';
                return questionHTML;
                
            } catch (error) {
                ErrorHandler.logError('Error generating question HTML', error);
                return '<div class="error-message">Error loading question</div>';
            }
        }

        function updateScaleValue(value) {
            try {
                const scaleValueElement = DOMUtils.safeGetElement('scale-value');
                if (scaleValueElement) {
                    scaleValueElement.textContent = value;
                    scaleValueElement.classList.add('updating');
                    setTimeout(() => {
                        scaleValueElement.classList.remove('updating');
                    }, 200);
                }
            } catch (error) {
                ErrorHandler.logError('Error updating scale value', error);
            }
        }
        
        function selectRadioOption(value, element) {
            try {
                document.querySelectorAll('.radio-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                element.classList.add('selected');
                const radioInput = element.querySelector('input');
                if (radioInput) {
                    radioInput.checked = true;
                }
            } catch (error) {
                ErrorHandler.logError('Error selecting radio option', error);
            }
        }
        
        function getCurrentResponse() {
            try {
                const scaleInput = DOMUtils.safeGetElement('question-response');
                if (scaleInput) {
                    return parseInt(scaleInput.value);
                }
                
                const radioInput = document.querySelector('input[name="question-response"]:checked');
                if (radioInput) {
                    return radioInput.value;
                }
                
                return null;
            } catch (error) {
                ErrorHandler.logError('Error getting current response', error);
                return null;
            }
        }
        
        function goToNextQuestion() {
            try {
                const response = getCurrentResponse();
                if (!response) {
                    showValidationMessage('Please answer the current question before continuing.');
                    return;
                }
                
                const saveResult = HSAssessmentService.saveResponse(assessmentState.currentQuestion.id, response);
                if (!saveResult.success) {
                    throw new Error(saveResult.error);
                }
                
                assessmentState.responses[assessmentState.currentQuestion.id] = response;
                
                const nextQuestionData = HSAssessmentService.nextQuestion();
                
                if (nextQuestionData.completed) {
                    DOMUtils.safeToggleClass('complete-assessment', 'hidden', false);
                    DOMUtils.safeToggleClass('next-question', 'hidden', true);
                } else {
                    displayCurrentQuestion();
                    updateProgress();
                }
                
                const progress = HSAssessmentService.getProgress();
                const prevBtn = DOMUtils.safeGetElement('prev-question');
                if (prevBtn) {
                    prevBtn.disabled = progress.current === 0;
                }
                
            } catch (error) {
                ErrorHandler.logError('Error advancing to next question', error);
                showValidationMessage('Failed to save response. Please try again.');
            }
        }
        
        function goToPreviousQuestion() {
            try {
                const prevQuestionData = HSAssessmentService.previousQuestion();
                
                if (!prevQuestionData.completed) {
                    displayCurrentQuestion();
                    updateProgress();
                    
                    DOMUtils.safeToggleClass('next-question', 'hidden', false);
                    DOMUtils.safeToggleClass('complete-assessment', 'hidden', true);
                }
                
                const progress = HSAssessmentService.getProgress();
                const prevBtn = DOMUtils.safeGetElement('prev-question');
                if (prevBtn) {
                    prevBtn.disabled = progress.current === 0;
                }
                
            } catch (error) {
                ErrorHandler.logError('Error going to previous question', error);
            }
        }
        
        function updateProgress() {
            try {
                const progress = HSAssessmentService.getProgress();
                
                DOMUtils.safeSetContent('assessment-progress', '');
                const progressElement = DOMUtils.safeGetElement('assessment-progress');
                if (progressElement) {
                    progressElement.style.width = progress.percentage + '%';
                }
                
                DOMUtils.safeSetContent('question-counter', `Question ${progress.current + 1} of ${progress.total}`, 'text');
                DOMUtils.safeSetContent('progress-percentage', `${progress.percentage}%`, 'text');
                
            } catch (error) {
                ErrorHandler.logError('Error updating progress', error);
            }
        }
        
        async function handleAssessmentComplete() {
            console.log('🎯 Completing assessment and saving to Airtable');
            
            try {
                DOMUtils.safeToggleClass('assessment-loading', 'hidden', false);
                
                const response = getCurrentResponse();
                if (response && assessmentState.currentQuestion) {
                    const saveResult = HSAssessmentService.saveResponse(assessmentState.currentQuestion.id, response);
                    if (!saveResult.success) {
                        throw new Error(saveResult.error);
                    }
                    assessmentState.responses[assessmentState.currentQuestion.id] = response;
                }
                
                assessmentState.assessmentCompleted = true;
                
                const allResponses = HSAssessmentService.getAllResponses();
                const analysisResults = generateAnalyticsResults(allResponses.responses);
                
                // Prepare data for Airtable
                const airtableData = {
                    email: assessmentState.userDetails.email,
                    productName: assessmentState.userDetails.productName,
                    businessModel: assessmentState.userDetails.businessModel,
                    customerCount: assessmentState.userDetails.customerCount,
                    distinguishingFeature: assessmentState.userDetails.distinguishingFeature,
                    
                    overallScore: analysisResults.overall.score,
                    buyerScore: analysisResults.categories['buyer-understanding'].score,
                    techScore: analysisResults.categories['tech-to-value'].score,
                    
                    // Calculate additional fields for Airtable
                    revenueOpportunity: calculateRevenueOpportunity(analysisResults),
                    roiMultiplier: calculateROIMultiplier(analysisResults),
                    isHighPriority: analysisResults.overall.score < 40,
                    leadPriority: analysisResults.overall.score < 40 ? 'High' : 
                                 analysisResults.overall.score < 60 ? 'Medium' : 'Low',
                    
                    focusArea: analysisResults.categories['buyer-understanding'].score < 
                              analysisResults.categories['tech-to-value'].score ? 
                              'Buyer Understanding' : 'Tech-to-Value Translation',
                    
                    riskLevel: analysisResults.overall.score < 40 ? 'Critical' : 
                              analysisResults.overall.score < 60 ? 'High' : 'Medium',
                              
                    challengesCount: calculateChallengesCount(analysisResults),
                    
                    responses: allResponses.responses,
                    sessionId: assessmentState.sessionId,
                    startTime: assessmentState.assessmentStartTime
                };
                
                // Save to Airtable
                const saveResult = await saveToAirtable(airtableData);
                
                if (saveResult.success) {
                    assessmentState.airtableRecordId = saveResult.recordId;
                    console.log('✅ Assessment completed and saved to Airtable');
                } else {
                    console.warn('⚠️ Airtable save failed, continuing with local flow');
                }
                
                // Store analysis results and proceed
                assessmentState.analysisResults = analysisResults;
                assessmentState.analyticsCompleted = true;
                
                // Proceed to next step
                setTimeout(() => {
                    try {
                        assessmentState.analysisResults = analysisResults;
                        assessmentState.analyticsCompleted = true;
                        
                        showStep(3);
                        displayAnalyticsResults(assessmentState.analysisResults);
                        
                    } catch (error) {
                        ErrorHandler.logError('Analytics generation error', error);
                        showAnalyticsPlaceholder(allResponses);
                    }
                    
                    DOMUtils.safeToggleClass('assessment-loading', 'hidden', true);
                }, 1000);
                
            } catch (error) {
                ErrorHandler.logError('Assessment completion error', error);
                showValidationMessage('Assessment completed locally. Redirecting...');
                DOMUtils.safeToggleClass('assessment-loading', 'hidden', true);
                
                // Continue with flow even if there are errors
                setTimeout(() => {
                    const fallbackData = {
                        score: 45,
                        challenges: 3,
                        riskLevel: 'Medium',
                        revenueOpportunity: '$500K'
                    };
                    proceedToWaitlistWithFallback(fallbackData);
                }, 2000);
            }
        }

        // =============================================================================
        // REPAIRED: ANALYTICS GENERATION
        // =============================================================================
        
        function generateAnalyticsResults(responses) {
            try {
                let buyerScore = 0;
                let techScore = 0;
                let responseCount = 0;
                
                const buyerQuestions = ['conversationConfidence', 'valuePropositionSpecificity', 'objectionPredictability', 
                                       'stakeholderAwareness', 'buyerJourneyUnderstanding', 'championIdentification', 
                                       'referenceComfortLevel', 'industrySpecificValue'];
                
                buyerQuestions.forEach(questionId => {
                    if (responses[questionId] !== undefined) {
                        let score = 0;
                        const value = responses[questionId];
                        
                        if (typeof value === 'number') {
                            score = (value - 1) * 10;
                        } else {
                            if (value === 'yes') score = 85;
                            else if (value === 'no') score = 15;
                            else if (value === '5+') score = 90;
                            else if (value === '3-4') score = 70;
                            else if (value === '1-2') score = 35;
                            else if (value === 'not-sure') score = 10;
                            else if (value === 'all') score = 95;
                            else if (value === 'most') score = 80;
                            else if (value === 'some') score = 45;
                        }
                        buyerScore += score;
                        responseCount++;
                    }
                });
                
                buyerScore = responseCount > 0 ? Math.round(buyerScore / buyerQuestions.length) : 0;
                
                const techQuestions = ['featureTranslationAbility', 'technicalObjectionFrequency', 'competitiveDifferentiation',
                                      'businessCaseCreation', 'successMetricClarity', 'executiveReadiness'];
                
                techQuestions.forEach(questionId => {
                    if (responses[questionId] !== undefined) {
                        let score = 0;
                        const value = responses[questionId];
                        
                        if (typeof value === 'number') {
                            if (questionId === 'technicalObjectionFrequency') {
                                score = (11 - value - 1) * 10;
                            } else {
                                score = (value - 1) * 10;
                            }
                        } else {
                            if (value === 'yes') score = 85;
                            else if (value === 'no') score = 15;
                        }
                        techScore += score;
                    }
                });
                
                techScore = Math.round(techScore / techQuestions.length);
                
                const overallScore = Math.round((buyerScore * 0.6) + (techScore * 0.4));
                
                let level = 'critical';
                if (overallScore >= 85) level = 'excellent';
                else if (overallScore >= 70) level = 'good';
                else if (overallScore >= 55) level = 'average';
                else if (overallScore >= 40) level = 'needs-work';
                
                return {
                    overall: {
                        score: overallScore,
                        level: level,
                        percentile: Math.min(95, Math.max(10, Math.round(overallScore * 0.9))),
                        description: `Your revenue performance score is ${overallScore}/100 (${level} level)`
                    },
                    categories: {
                        'buyer-understanding': {
                            score: buyerScore,
                            weight: '60%',
                            title: 'Buyer Understanding',
                            description: 'How well you understand and engage with enterprise buyers'
                        },
                        'tech-to-value': {
                            score: techScore,
                            weight: '40%',
                            title: 'Tech-to-Value Translation', 
                            description: 'Your ability to translate technical features into business value'
                        }
                    },
                    insights: [
                        `Overall performance level: ${level}`,
                        `Buyer understanding: ${buyerScore}/100`,
                        `Technical translation: ${techScore}/100`,
                        `${Math.abs(buyerScore - techScore) > 20 ? 'Significant gap between buyer and technical skills' : 'Balanced performance across categories'}`
                    ]
                };
                
            } catch (error) {
                ErrorHandler.logError('Error generating analytics', error);
                throw error;
            }
        }
        
        function displayAnalyticsResults(analysis) {
            try {
                console.log('📊 Displaying analytics results');
                
                const analyticsHTML = `
                    <div style="text-align: center; padding: var(--spacing-3xl);">
                        <div style="font-size: 64px; margin-bottom: var(--spacing-xl);">📊</div>
                        <h3 style="color: var(--color-text-primary); margin-bottom: var(--spacing-md); font-size: var(--font-size-2xl);">
                            Your Revenue Performance Analysis
                        </h3>
                        
                        <div style="background: var(--color-background-tertiary); border-radius: var(--border-radius-md); padding: var(--spacing-2xl); margin: var(--spacing-xl) 0; border: 1px solid var(--color-surface);">
                            <div style="font-size: var(--font-size-4xl); color: var(--color-brand-primary); font-weight: 300; margin-bottom: var(--spacing-sm);">
                                ${analysis.overall.score}/100
                            </div>
                            <div style="color: var(--color-text-primary); font-size: var(--font-size-lg); margin-bottom: var(--spacing-md);">
                                ${analysis.overall.level.charAt(0).toUpperCase() + analysis.overall.level.slice(1)} Performance
                            </div>
                            <div style="color: var(--color-text-muted); font-size: var(--font-size-sm);">
                                ${analysis.overall.percentile}th percentile
                            </div>
                            
                            <!-- Social Sharing Button -->
                            <button onclick="showSocialSharing()" class="btn btn-secondary" style="margin-top: var(--spacing-lg); padding: var(--spacing-sm) var(--spacing-lg); font-size: var(--font-size-sm);">
                                📱 Share Results on LinkedIn
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin: var(--spacing-xl) 0;">
                            <div style="background: var(--color-background-secondary); padding: var(--spacing-lg); border-radius: var(--border-radius-sm); border: 1px solid var(--color-surface);">
                                <div style="color: var(--color-brand-primary); font-size: var(--font-size-2xl); font-weight: 300;">
                                    ${analysis.categories['buyer-understanding'].score}
                                </div>
                                <div style="color: var(--color-text-primary); font-size: var(--font-size-sm); font-weight: 600;">
                                    Buyer Understanding
                                </div>
                                <div style="color: var(--color-text-muted); font-size: var(--font-size-xs);">
                                    (${analysis.categories['buyer-understanding'].weight} weight)
                                </div>
                            </div>
                            
                            <div style="background: var(--color-background-secondary); padding: var(--spacing-lg); border-radius: var(--border-radius-sm); border: 1px solid var(--color-surface);">
                                <div style="color: var(--color-brand-secondary); font-size: var(--font-size-2xl); font-weight: 300;">
                                    ${analysis.categories['tech-to-value'].score}
                                </div>
                                <div style="color: var(--color-text-primary); font-size: var(--font-size-sm); font-weight: 600;">
                                    Tech-to-Value
                                </div>
                                <div style="color: var(--color-text-muted); font-size: var(--font-size-xs);">
                                    (${analysis.categories['tech-to-value'].weight} weight)
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: var(--color-background-tertiary); border-radius: var(--border-radius-sm); padding: var(--spacing-lg); margin: var(--spacing-xl) 0; border-left: 4px solid var(--color-brand-primary);">
                            <h4 style="color: var(--color-text-primary); margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm);">
                                💡 Key Insights
                            </h4>
                            <ul style="list-style: none; padding: 0; margin: 0; text-align: left;">
                                ${analysis.insights.map(insight => `
                                    <li style="color: var(--color-text-muted); margin-bottom: var(--spacing-sm); padding-left: var(--spacing-md); position: relative;">
                                        <span style="position: absolute; left: 0; color: var(--color-brand-primary);">•</span>
                                        ${insight}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <!-- Conversion Tracking Display -->
                        <div style="background: rgba(6, 182, 212, 0.05); border: 1px solid rgba(6, 182, 212, 0.2); border-radius: var(--border-radius-sm); padding: var(--spacing-lg); margin: var(--spacing-xl) 0;">
                            <h4 style="color: var(--color-brand-primary); margin-bottom: var(--spacing-md); font-size: var(--font-size-sm);">
                                📈 Performance Metrics
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: var(--spacing-md); text-align: center;">
                                <div>
                                    <div style="color: var(--color-brand-primary); font-size: var(--font-size-lg); font-weight: 300;">${analysis.overall.percentile}th</div>
                                    <div style="color: var(--color-text-muted); font-size: var(--font-size-xs);">Percentile</div>
                                </div>
                                <div>
                                    <div style="color: var(--color-brand-secondary); font-size: var(--font-size-lg); font-weight: 300;">14/14</div>
                                    <div style="color: var(--color-text-muted); font-size: var(--font-size-xs);">Completed</div>
                                </div>
                                <div>
                                    <div style="color: var(--color-accent-warning); font-size: var(--font-size-lg); font-weight: 300;" id="completion-time">-</div>
                                    <div style="color: var(--color-text-muted); font-size: var(--font-size-xs);">Minutes</div>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="proceedToChallenges()" style="margin-top: var(--spacing-xl); padding: var(--spacing-lg) var(--spacing-3xl);">
                            🔍 Identify Specific Challenges
                            <span class="loading-spinner hidden" id="analytics-next-loading">⏳</span>
                        </button>
                        
                        <p style="color: var(--color-text-subtle); font-size: var(--font-size-xs); margin-top: var(--spacing-md);">
                            Next: Detailed challenge analysis and solution recommendations
                        </p>
                    </div>
                `;
                
                DOMUtils.safeSetContent('analytics-content', analyticsHTML);
                
                // Calculate and display completion time
                if (assessmentState.assessmentStartTime) {
                    const completionTime = Math.round((Date.now() - assessmentState.assessmentStartTime) / 60000);
                    DOMUtils.safeSetContent('completion-time', completionTime.toString(), 'text');
                }
                
                // Track analytics display
                CohortTracker.trackUserJourney(
                    assessmentState.sessionId,
                    'assessment-qualified',
                    'analytics-displayed',
                    { 
                        score: analysis.overall.score,
                        level: analysis.overall.level,
                        percentile: analysis.overall.percentile
                    }
                );
                
            } catch (error) {
                ErrorHandler.logError('Error displaying analytics', error);
                showAnalyticsPlaceholder({ answeredQuestions: Object.keys(assessmentState.responses).length });
            }
        }
        
        // Social sharing wrapper function
        function showSocialSharing() {
            try {
                if (!assessmentState.analysisResults) {
                    ErrorHandler.showUserError('Assessment results not available for sharing.');
                    return;
                }
                
                const shareData = {
                    score: assessmentState.analysisResults.overall.score,
                    challenges: assessmentState.detectedChallenges?.summary?.totalChallenges || 'Multiple',
                    riskLevel: assessmentState.detectedChallenges?.summary?.overallRisk || 'Medium',
                    focusArea: assessmentState.detectedChallenges?.summary?.focusArea || 'Revenue Optimization',
                    revenueOpportunity: calculateRevenueOpportunity(assessmentState.analysisResults)
                };
                
                SocialShareGenerator.showSharingModal(shareData);
                
            } catch (error) {
                ErrorHandler.logError('Social sharing initialization error', error);
            }
        }
        
        function showAnalyticsPlaceholder(allResponses) {
            const placeholderHTML = `
                <div style="text-align: center; padding: var(--spacing-4xl);">
                    <div style="font-size: 48px; margin-bottom: var(--spacing-2xl);">📊</div>
                    <h3 style="color: var(--color-text-primary); margin-bottom: var(--spacing-lg);">Analysis Complete!</h3>
                    <p style="color: var(--color-text-muted);">
                        Your assessment results have been analyzed with ${allResponses.answeredQuestions} responses recorded.
                    </p>
                    <button class="btn btn-primary" onclick="proceedToChallenges()" style="margin-top: var(--spacing-xl);">
                        View Challenge Analysis
                    </button>
                </div>
            `;
            DOMUtils.safeSetContent('analytics-content', placeholderHTML);
        }
        
        function proceedToChallenges() {
            console.log('🔍 Proceeding to challenge identification');
            
            try {
                DOMUtils.safeToggleClass('analytics-next-loading', 'hidden', false);
                
                setTimeout(() => {
                    showStep(4);
                    DOMUtils.safeToggleClass('analytics-next-loading', 'hidden', true);
                }, 800);
                
            } catch (error) {
                ErrorHandler.logError('Error proceeding to challenges', error);
                DOMUtils.safeToggleClass('analytics-next-loading', 'hidden', true);
            }
        }

        // =============================================================================
        // REPAIRED: CHALLENGE DETECTION FUNCTIONS
        // =============================================================================
        
        function handleChallengeDetection() {
            console.log('🔍 Detecting challenges and preparing waitlist integration');
            
            try {
                if (!assessmentState.analysisResults) {
                    throw new Error('Analytics results not available');
                }
                
                const challengeAnalysis = generateChallengeAnalysis(assessmentState.analysisResults, assessmentState.responses);
                assessmentState.detectedChallenges = challengeAnalysis;
                assessmentState.challengesCompleted = true;
                
                displayChallenges(challengeAnalysis);
                prepareWaitlistIntegration();
                
            } catch (error) {
                ErrorHandler.logError('Challenge detection error', error);
            }
        }
        
        function generateChallengeAnalysis(analysisResults, responses) {
            try {
                const challenges = [];
                const score = analysisResults.overall.score;
                const buyerScore = analysisResults.categories['buyer-understanding'].score;
                const techScore = analysisResults.categories['tech-to-value'].score;
                
                if (buyerScore < 60) {
                    challenges.push({
                        id: 'buyer_conversations',
                        category: 'Buyer Understanding',
                        severity: buyerScore < 30 ? 'Critical' : 'High',
                        title: 'Difficulty with Enterprise Buyer Conversations',
                        description: 'You struggle to have productive conversations with enterprise buyers about their business challenges and decision-making process.',
                        impact: 'Lost deals due to inability to connect technical features to business outcomes',
                        evidence: [
                            `Conversation confidence: ${responses.conversationConfidence || 'Low'}/10`,
                            `Objection handling: ${responses.objectionPredictability === 'no' ? 'Unpredictable' : 'Manageable'}`,
                            `Stakeholder awareness: ${responses.stakeholderAwareness || 'Limited'}`
                        ]
                    });
                }
                
                if (responses.valuePropositionSpecificity < 6 || buyerScore < 50) {
                    challenges.push({
                        id: 'value_clarity',
                        category: 'Buyer Understanding',
                        severity: responses.valuePropositionSpecificity < 4 ? 'Critical' : 'Medium',
                        title: 'Vague Value Proposition',
                        description: 'Your value proposition lacks specificity and measurable benefits for different customer segments.',
                        impact: 'Prospects cannot understand concrete ROI, leading to extended sales cycles',
                        evidence: [
                            `Value specificity: ${responses.valuePropositionSpecificity || 'Unknown'}/10`,
                            `Industry customization: ${responses.industrySpecificValue || 'Unknown'}/10`
                        ]
                    });
                }
                
                if (techScore < 60) {
                    challenges.push({
                        id: 'technical_translation',
                        category: 'Tech-to-Value Translation',
                        severity: techScore < 30 ? 'Critical' : 'High',
                        title: 'Poor Technical-to-Business Translation',
                        description: 'You focus too heavily on technical features without translating them into business outcomes.',
                        impact: 'Prospects get lost in technical details and fail to see business value',
                        evidence: [
                            `Feature translation ability: ${responses.featureTranslationAbility || 'Unknown'}/10`,
                            `Technical objection frequency: ${responses.technicalObjectionFrequency || 'Unknown'}/10`,
                            `Executive readiness: ${responses.executiveReadiness || 'No'}`
                        ]
                    });
                }
                
                if (responses.competitiveDifferentiation < 6) {
                    challenges.push({
                        id: 'competitive_positioning',
                        category: 'Tech-to-Value Translation',
                        severity: responses.competitiveDifferentiation < 4 ? 'High' : 'Medium',
                        title: 'Weak Competitive Differentiation',
                        description: 'You cannot clearly articulate why your technical approach creates superior business outcomes.',
                        impact: 'Lost deals to competitors with clearer positioning',
                        evidence: [
                            `Differentiation clarity: ${responses.competitiveDifferentiation || 'Unknown'}/10`,
                            `Business case creation: ${responses.businessCaseCreation || 'No'}`
                        ]
                    });
                }
                
                if (responses.buyerJourneyUnderstanding === 'no' || responses.championIdentification === 'not-sure') {
                    challenges.push({
                        id: 'sales_process',
                        category: 'Buyer Understanding',
                        severity: 'Medium',
                        title: 'Unstructured Sales Process',
                        description: 'You lack systematic approaches to managing complex B2B sales cycles.',
                        impact: 'Inconsistent results and missed opportunities in enterprise deals',
                        evidence: [
                            `Buyer journey understanding: ${responses.buyerJourneyUnderstanding || 'No'}`,
                            `Champion identification: ${responses.championIdentification || 'Inconsistent'}`
                        ]
                    });
                }
                
                if (responses.referenceComfortLevel < 7) {
                    challenges.push({
                        id: 'social_proof',
                        category: 'Buyer Understanding',
                        severity: 'Medium',
                        title: 'Insufficient Social Proof',
                        description: 'Your customers are not comfortable serving as references, indicating satisfaction issues.',
                        impact: 'Difficulty closing deals without strong reference validation',
                        evidence: [
                            `Reference comfort level: ${responses.referenceComfortLevel || 'Unknown'}/10`
                        ]
                    });
                }
                
                const criticalCount = challenges.filter(c => c.severity === 'Critical').length;
                const highCount = challenges.filter(c => c.severity === 'High').length;
                
                let overallRisk = 'Medium';
                if (criticalCount >= 2) overallRisk = 'Critical';
                else if (criticalCount >= 1 || highCount >= 2) overallRisk = 'High';
                
                const focusArea = buyerScore < techScore ? 'Buyer Understanding' : 'Tech-to-Value Translation';
                
                return {
                    challenges: challenges,
                    summary: {
                        totalChallenges: challenges.length,
                        criticalChallenges: criticalCount,
                        highChallenges: highCount,
                        overallRisk: overallRisk,
                        focusArea: focusArea,
                        description: `${challenges.length} optimization opportunities identified with ${overallRisk.toLowerCase()} risk level`
                    }
                };
                
            } catch (error) {
                ErrorHandler.logError('Error generating challenge analysis', error);
                return {
                    challenges: [],
                    summary: {
                        totalChallenges: 0,
                        criticalChallenges: 0,
                        highChallenges: 0,
                        overallRisk: 'Unknown',
                        focusArea: 'General',
                        description: 'Challenge analysis unavailable'
                    }
                };
            }
        }
        
        function displayChallenges(challengeAnalysis) {
            try {
                console.log('🔍 Displaying challenge analysis');
                
                const challengesHTML = `
                    <div style="text-align: center; padding: var(--spacing-3xl);">
                        <div style="font-size: 64px; margin-bottom: var(--spacing-xl);">🔍</div>
                        <h3 style="color: var(--color-text-primary); margin-bottom: var(--spacing-md); font-size: var(--font-size-2xl);">
                            Challenge Analysis Complete
                        </h3>
                        
                        <div style="background: var(--color-background-tertiary); border-radius: var(--border-radius-md); padding: var(--spacing-2xl); margin: var(--spacing-xl) 0; border: 1px solid var(--color-surface);">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                                <div style="text-align: center;">
                                    <div style="font-size: var(--font-size-3xl); color: var(--color-accent-danger); font-weight: 300;">
                                        ${challengeAnalysis.summary.totalChallenges}
                                    </div>
                                    <div style="color: var(--color-text-muted); font-size: var(--font-size-sm);">Total Challenges</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: var(--font-size-2xl); color: ${challengeAnalysis.summary.overallRisk === 'Critical' ? 'var(--color-accent-danger)' : challengeAnalysis.summary.overallRisk === 'High' ? 'var(--color-accent-warning)' : 'var(--color-brand-secondary)'}; font-weight: 300;">
                                        ${challengeAnalysis.summary.overallRisk}
                                    </div>
                                    <div style="color: var(--color-text-muted); font-size: var(--font-size-sm);">Risk Level</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: var(--font-size-lg); color: var(--color-brand-primary); font-weight: 300;">
                                        ${challengeAnalysis.summary.focusArea}
                                    </div>
                                    <div style="color: var(--color-text-muted); font-size: var(--font-size-sm);">Focus Area</div>
                                </div>
                            </div>
                            <p style="color: var(--color-text-secondary); margin-bottom: 0;">
                                ${challengeAnalysis.summary.description}
                            </p>
                        </div>
                        
                        <div style="display: grid; gap: var(--spacing-lg); margin: var(--spacing-xl) 0; text-align: left;">
                            ${challengeAnalysis.challenges.map(challenge => `
                                <div style="background: var(--color-background-secondary); border-radius: var(--border-radius-sm); padding: var(--spacing-xl); border: 1px solid var(--color-surface); border-left: 4px solid ${challenge.severity === 'Critical' ? 'var(--color-accent-danger)' : challenge.severity === 'High' ? 'var(--color-accent-warning)' : 'var(--color-brand-secondary)'};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                                        <h4 style="color: var(--color-text-primary); margin: 0; font-size: var(--font-size-lg);">
                                            ${challenge.title}
                                        </h4>
                                        <span style="background: ${challenge.severity === 'Critical' ? 'rgba(239, 68, 68, 0.2)' : challenge.severity === 'High' ? 'rgba(245, 158, 11, 0.2)' : 'rgba(16, 185, 129, 0.2)'}; color: ${challenge.severity === 'Critical' ? 'var(--color-accent-danger)' : challenge.severity === 'High' ? 'var(--color-accent-warning)' : 'var(--color-brand-secondary)'}; padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--border-radius-sm); font-size: var(--font-size-xs); font-weight: 600;">
                                            ${challenge.severity}
                                        </span>
                                    </div>
                                    <p style="color: var(--color-text-muted); margin-bottom: var(--spacing-md); line-height: 1.5;">
                                        ${challenge.description}
                                    </p>
                                    <div style="background: var(--color-background-tertiary); padding: var(--spacing-md); border-radius: var(--border-radius-sm); margin-bottom: var(--spacing-md);">
                                        <strong style="color: var(--color-text-primary); font-size: var(--font-size-sm);">Impact:</strong>
                                        <span style="color: var(--color-text-secondary); font-size: var(--font-size-sm);"> ${challenge.impact}</span>
                                    </div>
                                    <div style="font-size: var(--font-size-xs); color: var(--color-text-subtle);">
                                        <strong>Evidence:</strong> ${challenge.evidence.join(' • ')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button class="btn btn-primary" onclick="proceedToRecommendations()" style="margin-top: var(--spacing-xl); padding: var(--spacing-lg) var(--spacing-3xl);">
                            💡 Generate Solution Recommendations
                            <span class="loading-spinner hidden" id="challenges-next-loading">⏳</span>
                        </button>
                        
                        <p style="color: var(--color-text-subtle); font-size: var(--font-size-xs); margin-top: var(--spacing-md);">
                            Next: Personalized solutions for your specific challenges
                        </p>
                    </div>
                `;
                
                DOMUtils.safeSetContent('challenges-list', challengesHTML);
                
            } catch (error) {
                ErrorHandler.logError('Error displaying challenges', error);
            }
        }
        
        function proceedToRecommendations() {
            console.log('💡 Proceeding to recommendations generation');
            
            try {
                DOMUtils.safeToggleClass('challenges-next-loading', 'hidden', false);
                
                setTimeout(() => {
                    showStep(5);
                    DOMUtils.safeToggleClass('challenges-next-loading', 'hidden', true);
                }, 800);
                
            } catch (error) {
                ErrorHandler.logError('Error proceeding to recommendations', error);
                DOMUtils.safeToggleClass('challenges-next-loading', 'hidden', true);
            }
        }

        // =============================================================================
        // REPAIRED: RECOMMENDATIONS WITH STRIPE INTEGRATION 
        // =============================================================================
        
        function handleRecommendationsGeneration() {
            console.log('💡 Generating recommendations with Stripe integration');
            
            try {
                if (!assessmentState.challengesCompleted) {
                    throw new Error('Challenges not completed');
                }
                
                const recommendations = generateRecommendations(
                    assessmentState.detectedChallenges,
                    assessmentState.userDetails
                );
                
                assessmentState.recommendations = recommendations;
                assessmentState.recommendationsCompleted = true;
                
                displayRecommendations(recommendations);
                
            } catch (error) {
                ErrorHandler.logError('Recommendations generation error', error);
            }
        }
        
        function generateRecommendations(challengeAnalysis, userDetails) {
            try {
                const recommendations = [];
                const challenges = challengeAnalysis.challenges;
                const focusArea = challengeAnalysis.summary.focusArea;
                
                if (challenges.some(c => c.category === 'Buyer Understanding')) {
                    recommendations.push({
                        id: 'buyer_framework',
                        category: 'Buyer Understanding',
                        priority: 'High',
                        title: 'Enterprise Buyer Psychology Framework',
                        description: 'Master the systematic approach to understanding how technical buyers make decisions and what triggers their purchasing process.',
                        benefits: [
                            'Predict buyer objections before they happen',
                            'Identify key stakeholders and their concerns',
                            'Accelerate sales cycles by 40%'
                        ],
                        implementation: '15-minute framework setup + practice scenarios',
                        timeToImpact: '1-2 weeks',
                        applicableFor: userDetails.businessModel === 'b2b' ? 'Perfect for B2B technical products' : 'Adaptable for B2C with enterprise features'
                    });
                }
                
                if (challenges.some(c => c.category === 'Tech-to-Value Translation')) {
                    recommendations.push({
                        id: 'tech_translation',
                        category: 'Tech-to-Value Translation',
                        priority: 'High',
                        title: 'Feature-to-Value Translation Scripts',
                        description: 'Convert technical capabilities into concrete business outcomes and ROI calculations that resonate with decision makers.',
                        benefits: [
                            'Stop losing prospects in technical details',
                            'Present confidently to C-level executives',
                            'Build compelling business cases quickly'
                        ],
                        implementation: 'Template-based system with pre-built scenarios',
                        timeToImpact: '1 week',
                        applicableFor: `Ideal for ${userDetails.productDescription ? 'technical products like yours' : 'complex technical solutions'}`
                    });
                }
                
                if (challenges.some(c => c.id === 'competitive_positioning')) {
                    recommendations.push({
                        id: 'competitive_positioning',
                        category: 'Market Positioning',
                        priority: 'Medium',
                        title: 'Technical Differentiation Playbook',
                        description: 'Position your technical advantages as compelling business differentiators that justify premium pricing.',
                        benefits: [
                            'Win against inferior products with better sales execution',
                            'Justify premium pricing with technical superiority',
                            'Reduce price-based objections'
                        ],
                        implementation: 'Competitive analysis worksheet + positioning templates',
                        timeToImpact: '2-3 weeks',
                        applicableFor: `Especially relevant for ${userDetails.distinguishingFeature ? `products with unique features like "${userDetails.distinguishingFeature}"` : 'differentiated technical solutions'}`
                    });
                }
                
                if (challenges.some(c => c.id === 'sales_process')) {
                    recommendations.push({
                        id: 'sales_process',
                        category: 'Process Optimization',
                        priority: 'Medium',
                        title: 'Systematic Sales Process Framework',
                        description: 'Implement proven methodologies for managing complex B2B sales cycles with multiple stakeholders.',
                        benefits: [
                            'Consistent results across all deals',
                            'Better forecasting and pipeline management',
                            'Higher close rates with larger deals'
                        ],
                        implementation: 'Step-by-step process maps + tracking templates',
                        timeToImpact: '3-4 weeks',
                        applicableFor: userDetails.customerCount === '1-10' ? 'Essential for scaling beyond early customers' : 'Perfect for optimizing existing sales processes'
                    });
                }
                
                if (challenges.some(c => c.id === 'social_proof')) {
                    recommendations.push({
                        id: 'customer_success',
                        category: 'Social Proof',
                        priority: 'Low',
                        title: 'Reference Customer Development',
                        description: 'Transform satisfied customers into powerful sales assets through systematic reference development.',
                        benefits: [
                            'Stronger social proof for prospects',
                            'Reduced sales cycle length',
                            'Higher win rates in competitive situations'
                        ],
                        implementation: 'Customer success playbook + reference templates',
                        timeToImpact: '4-6 weeks',
                        applicableFor: `Great for companies with ${userDetails.customerCount || 'existing'} customers ready to advocate`
                    });
                }
                
                return {
                    recommendations: recommendations,
                    summary: {
                        totalRecommendations: recommendations.length,
                        highPriority: recommendations.filter(r => r.priority === 'High').length,
                        focusArea: focusArea,
                        estimatedImpact: challengeAnalysis.summary.overallRisk === 'Critical' ? '$1.2M+ revenue opportunity' : challengeAnalysis.summary.overallRisk === 'High' ? '$750K revenue opportunity' : '$400K revenue opportunity',
                        implementationTime: '2-4 weeks for core improvements'
                    }
                };
                
            } catch (error) {
                ErrorHandler.logError('Error generating recommendations', error);
                return {
                    recommendations: [],
                    summary: {
                        totalRecommendations: 0,
                        highPriority: 0,
                        focusArea: 'General',
                        estimatedImpact: 'Impact calculation unavailable',
                        implementationTime: 'Timeline unavailable'
                    }
                };
            }
        }
        
        function displayRecommendations(recommendationData) {
            try {
                console.log('💡 Displaying recommendations');
                
                const recommendationsHTML = `
                    <div style="text-align: center; padding: var(--spacing-3xl);">
                        <div style="font-size: 64px; margin-bottom: var(--spacing-xl);">💡</div>
                        <h3 style="color: var(--color-text-primary); margin-bottom: var(--spacing-md); font-size: var(--font-size-2xl);">
                            Your Personalized Solution Recommendations
                        </h3>
                        
                        <div style="background: var(--color-background-tertiary); border-radius: var(--border-radius-md); padding: var(--spacing-2xl); margin: var(--spacing-xl) 0; border: 1px solid var(--color-surface);">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                                <div style="text-align: center;">
                                    <div style="font-size: var(--font-size-3xl); color: var(--color-brand-primary); font-weight: 300;">
                                        ${recommendationData.summary.totalRecommendations}
                                    </div>
                                    <div style="color: var(--color-text-muted); font-size: var(--font-size-sm);">Solutions</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: var(--font-size-2xl); color: var(--color-brand-secondary); font-weight: 300;">
                                        ${recommendationData.summary.highPriority}
                                    </div>
                                    <div style="color: var(--color-text-muted); font-size: var(--font-size-sm);">High Priority</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: var(--font-size-lg); color: var(--color-accent-warning); font-weight: 300;">
                                        ${recommendationData.summary.implementationTime}
                                    </div>
                                    <div style="color: var(--color-text-muted); font-size: var(--font-size-sm);">Timeline</div>
                                </div>
                            </div>
                            <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-md);">
                                <strong>${recommendationData.summary.estimatedImpact}</strong> potential revenue impact
                            </p>
                            <p style="color: var(--color-text-muted); margin-bottom: 0; font-size: var(--font-size-sm);">
                                Focus: ${recommendationData.summary.focusArea} optimization
                            </p>
                        </div>
                        
                        <div style="display: grid; gap: var(--spacing-lg); margin: var(--spacing-xl) 0; text-align: left;">
                            ${recommendationData.recommendations.map(rec => `
                                <div style="background: var(--color-background-secondary); border-radius: var(--border-radius-sm); padding: var(--spacing-xl); border: 1px solid var(--color-surface); border-left: 4px solid ${rec.priority === 'High' ? 'var(--color-brand-primary)' : rec.priority === 'Medium' ? 'var(--color-accent-warning)' : 'var(--color-brand-secondary)'};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                                        <h4 style="color: var(--color-text-primary); margin: 0; font-size: var(--font-size-lg);">
                                            ${rec.title}
                                        </h4>
                                        <span style="background: ${rec.priority === 'High' ? 'rgba(6, 182, 212, 0.2)' : rec.priority === 'Medium' ? 'rgba(245, 158, 11, 0.2)' : 'rgba(16, 185, 129, 0.2)'}; color: ${rec.priority === 'High' ? 'var(--color-brand-primary)' : rec.priority === 'Medium' ? 'var(--color-accent-warning)' : 'var(--color-brand-secondary)'}; padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--border-radius-sm); font-size: var(--font-size-xs); font-weight: 600;">
                                            ${rec.priority} Priority
                                        </span>
                                    </div>
                                    <p style="color: var(--color-text-muted); margin-bottom: var(--spacing-md); line-height: 1.5;">
                                        ${rec.description}
                                    </p>
                                    
                                    <div style="background: var(--color-background-tertiary); padding: var(--spacing-md); border-radius: var(--border-radius-sm); margin-bottom: var(--spacing-md);">
                                        <strong style="color: var(--color-brand-secondary); font-size: var(--font-size-sm);">Key Benefits:</strong>
                                        <ul style="margin: var(--spacing-sm) 0 0 var(--spacing-lg); color: var(--color-text-secondary); font-size: var(--font-size-sm);">
                                            ${rec.benefits.map(benefit => `<li style="margin-bottom: var(--spacing-xs);">${benefit}</li>`).join('')}
                                        </ul>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); font-size: var(--font-size-xs); color: var(--color-text-subtle);">
                                        <div>
                                            <strong>Implementation:</strong> ${rec.implementation}
                                        </div>
                                        <div>
                                            <strong>Time to Impact:</strong> ${rec.timeToImpact}
                                        </div>
                                    </div>
                                    <div style="margin-top: var(--spacing-sm); font-size: var(--font-size-xs); color: var(--color-text-subtle);">
                                        <strong>Perfect for:</strong> ${rec.applicableFor}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(6, 182, 212, 0.2); border-radius: var(--border-radius-md); padding: var(--spacing-2xl); margin: var(--spacing-3xl) 0;">
                            <h4 style="color: var(--color-brand-primary); font-size: var(--font-size-xl); margin-bottom: var(--spacing-lg); display: flex; align-items: center; gap: var(--spacing-sm);">
                                🎯 Ready to Implement These Solutions?
                            </h4>
                            <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-xl); line-height: 1.6; font-size: var(--font-size-base);">
                                Get access to systematic frameworks, templates, and step-by-step implementation guides 
                                designed specifically for technical founders. Join our waitlist to be notified when 
                                our founding member program launches.
                            </p>
                            
                            <div style="text-align: center;">
                                <button class="btn btn-primary" onclick="proceedToWaitlist()" style="padding: var(--spacing-lg) var(--spacing-3xl); font-size: var(--font-size-lg); margin-bottom: var(--spacing-lg);">
                                    📋 Join Founding Member Waitlist
                                    <span class="loading-spinner hidden" id="waitlist-loading">⏳</span>
                                </button>
                                
                                <div style="margin-top: var(--spacing-lg);">
                                    <button class="btn btn-secondary" onclick="shareAssessmentToLinkedIn()" style="padding: var(--spacing-md) var(--spacing-xl); font-size: var(--font-size-base);">
                                        📱 Share on LinkedIn
                                    </button>
                                </div>
                                
                                <p style="color: var(--color-text-subtle); font-size: var(--font-size-xs); margin-top: var(--spacing-md);">
                                    Your assessment data will personalize your experience
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                DOMUtils.safeSetContent('recommendations-list', recommendationsHTML);
                
            } catch (error) {
                ErrorHandler.logError('Error displaying recommendations', error);
            }
        }

        // =============================================================================
        // REPAIRED: WAITLIST & STRIPE INTEGRATION
        // =============================================================================
        
        function prepareWaitlistIntegration() {
            try {
                console.log('🚀 Preparing waitlist integration data');
                
                const assessmentContext = {
                    score: assessmentState.analysisResults?.overall?.score || 0,
                    challenges: assessmentState.detectedChallenges?.summary?.totalChallenges || 0,
                    riskLevel: assessmentState.detectedChallenges?.summary?.overallRisk || 'Medium',
                    focusArea: assessmentState.detectedChallenges?.summary?.focusArea || 'General',
                    
                    businessModel: assessmentState.userDetails.businessModel || 'b2b',
                    customerCount: assessmentState.userDetails.customerCount || 'unknown',
                    productName: assessmentState.userDetails.productName || '',
                    email: assessmentState.userDetails.email || '',
                    
                    revenueOpportunity: calculateRevenueOpportunity(assessmentState.analysisResults),
                    urgencyLevel: determineUrgencyLevel(assessmentState.analysisResults, assessmentState.detectedChallenges),
                    qualified: assessmentState.analysisResults?.overall?.score >= 30,
                    
                    source: 'hs_assessment_tool',
                    completedAt: new Date().toISOString(),
                    sessionId: assessmentState.sessionId
                };
                
                assessmentState.waitlistContext = assessmentContext;
                
                console.log('✅ Waitlist integration context prepared:', assessmentContext);
                
            } catch (error) {
                ErrorHandler.logError('Waitlist integration preparation error', error);
                assessmentState.waitlistContext = null;
            }
        }
        
        function calculateRevenueOpportunity(analysisResults) {
            try {
                const score = analysisResults?.overall?.score || 0;
                
                if (score < 40) return '$1.2M+';
                else if (score < 60) return '$750K';
                else if (score < 80) return '$400K';
                else return '$200K';
                
            } catch (error) {
                return '$500K';
            }
        }
        
        function determineUrgencyLevel(analysisResults, challengeAnalysis) {
            try {
                const score = analysisResults?.overall?.score || 0;
                const challengeCount = challengeAnalysis?.summary?.totalChallenges || 0;
                
                if (score < 40 || challengeCount >= 6) return 'Critical';
                else if (score < 60 || challengeCount >= 4) return 'High';
                else return 'Medium';
                
            } catch (error) {
                return 'Medium';
            }
        }
        
        function proceedToWaitlist() {
            console.log('🚀 Proceeding to waitlist with assessment data');
            
            try {
                if (!assessmentState.waitlistContext) {
                    prepareWaitlistIntegration();
                }
                
                if (!assessmentState.waitlistContext) {
                    throw new Error('Waitlist context could not be prepared');
                }
                
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '🔄 Preparing your personalized experience...';
                button.disabled = true;
                
                ErrorHandler.showUserError('Transferring to personalized waitlist...', 'success');
                
                setTimeout(() => {
                    const waitlistUrl = buildWaitlistUrl(assessmentState.waitlistContext);
                    
                    console.log('📊 Transferring to waitlist with data:', assessmentState.waitlistContext);
                    console.log('🌐 Waitlist URL:', waitlistUrl);
                    
                    try {
                        // Track the redirect attempt
                        CohortTracker.trackUserJourney(
                            assessmentState.sessionId,
                            'assessment-qualified',
                            'waitlist-redirect',
                            { 
                                waitlistUrl: waitlistUrl,
                                assessmentData: assessmentState.waitlistContext
                            }
                        );
                        
                        // Perform the redirect
                        window.location.href = waitlistUrl;
                        
                    } catch (redirectError) {
                        console.error('Redirect failed:', redirectError);
                        
                        // Fallback: Show the URL for manual navigation
                        const fallbackModal = document.createElement('div');
                        fallbackModal.style.cssText = `
                            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                            background: rgba(0,0,0,0.8); display: flex; align-items: center;
                            justify-content: center; z-index: 10000;
                        `;
                        fallbackModal.innerHTML = `
                            <div style="background: var(--color-background-secondary); padding: var(--spacing-3xl); 
                                        border-radius: var(--border-radius-md); max-width: 500px; text-align: center;">
                                <h3 style="color: var(--color-text-primary); margin-bottom: var(--spacing-lg);">
                                    🚀 Your Personalized Waitlist is Ready!
                                </h3>
                                <p style="color: var(--color-text-muted); margin-bottom: var(--spacing-lg);">
                                    Click the link below to access your personalized experience:
                                </p>
                                <a href="${waitlistUrl}" target="_blank" class="btn btn-primary" 
                                   style="display: inline-block; margin-bottom: var(--spacing-lg);">
                                    Open Personalized Waitlist
                                </a>
                                <p style="color: var(--color-text-subtle); font-size: var(--font-size-xs);">
                                    Your assessment data is included in this link
                                </p>
                            </div>
                        `;
                        document.body.appendChild(fallbackModal);
                        
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }
                }, 1500);
                
            } catch (error) {
                ErrorHandler.logError('Error proceeding to waitlist', error);
                ErrorHandler.showUserError('Failed to connect to waitlist. Please try again.');
                
                if (event && event.target) {
                    event.target.innerHTML = 'Try Again';
                    event.target.disabled = false;
                }
            }
        }

        // Fallback redirect function
        function proceedToWaitlistWithFallback(fallbackData) {
            const waitlistData = {
                email: assessmentState.userDetails?.email || '',
                productName: assessmentState.userDetails?.productName || '',
                score: fallbackData.score,
                challenges: fallbackData.challenges,
                riskLevel: fallbackData.riskLevel,
                revenueOpportunity: fallbackData.revenueOpportunity,
                source: 'hs_assessment_tool',
                sessionId: assessmentState.sessionId
            };
            
            const waitlistUrl = buildWaitlistUrl(waitlistData);
            console.log('🚀 Redirecting to waitlist:', waitlistUrl);
            window.location.href = waitlistUrl;
        }
        
        // FIXED: Complete buildWaitlistUrl function with proper error handling
        function buildWaitlistUrl(assessmentContext) {
            try {
                // Use the waitlist page on the same domain
                const baseUrl = `${window.location.origin}/waitlist`;
                
                const waitlistUrl = new URL(baseUrl);
        
                // Enhanced URL parameters including Airtable record ID
                const urlData = {
                    email: assessmentContext.email || '',
                    productName: assessmentContext.productName || '',
                    company: assessmentContext.productName || '',
                    score: assessmentContext.score || 0,
                    challenges: assessmentContext.challenges || 0,
                    riskLevel: assessmentContext.riskLevel || 'Medium',
                    focusArea: assessmentContext.focusArea || 'General',
                    revenueOpportunity: assessmentContext.revenueOpportunity || '$500K',
                    businessModel: assessmentContext.businessModel || '',
                    customerCount: assessmentContext.customerCount || '',
                    qualified: assessmentContext.qualified || false,
                    source: 'hs_assessment_tool',
                    sessionId: assessmentContext.sessionId || '',
                    airtableRecordId: assessmentState.airtableRecordId || '',
                    timestamp: new Date().toISOString()
                };
                
                // Add all assessment context as URL parameters
                Object.entries(urlData).forEach(([key, value]) => {
                    if (value !== null && value !== undefined && value !== '') {
                        waitlistUrl.searchParams.set(key, value.toString());
                    }
                });
                
                return waitlistUrl.toString();
                
            } catch (error) {
                ErrorHandler.logError('Error building waitlist URL', error);
                // Fallback to local waitlist with error flag
                return `${window.location.origin}/waitlist?source=hs_assessment_tool&error=url_generation_failed`;
            }
        }

        // =============================================================================
        // REPAIRED: INITIALIZATION SYSTEM
        // =============================================================================
        
        function initializeComponent1() {
            console.log('🔧 Initializing assessment functionality');
            
            try {
                const eventHandlers = [
                    { id: 'start-assessment-btn', event: 'click', handler: handleStartAssessment },
                    { id: 'next-question', event: 'click', handler: goToNextQuestion },
                    { id: 'prev-question', event: 'click', handler: goToPreviousQuestion },
                    { id: 'complete-assessment', event: 'click', handler: handleAssessmentComplete }
                ];
                
                let successCount = 0;
                
                eventHandlers.forEach(({ id, event, handler }) => {
                    if (DOMUtils.safeAddEventListener(id, event, handler)) {
                        successCount++;
                    }
                });
                
                console.log(`✅ Assessment initialization complete: ${successCount}/${eventHandlers.length} handlers attached`);
                
                if (successCount < eventHandlers.length) {
                    ErrorHandler.logError('Some event handlers failed to attach', null, { 
                        expected: eventHandlers.length, 
                        actual: successCount 
                    });
                }
                
                // Initialize exit-intent system
                ExitIntentManager.init();
                
            } catch (error) {
                ErrorHandler.handleCriticalError('Assessment initialization failed', error);
            }
        }

        function initializeApplication() {
            console.log('📋 Initializing H&S Assessment Application (Surgically Repaired)');
            
            try {
                const criticalElements = [
                    'hs-assessment-loading',
                    'main-assessment-container',
                    'user-details-section'
                ];
                
                const missingElements = criticalElements.filter(id => !DOMUtils.safeGetElement(id));
                
                if (missingElements.length > 0) {
                    throw new Error(`Critical elements missing: ${missingElements.join(', ')}`);
                }
                
                LoadingManager.start();
                
                console.log('🛠️ Debug commands available:');
                console.log('- debugAssessment() - show current state');
                console.log('- testErrorHandling() - test error systems');
                console.log('- skipToAnalytics() - skip to analytics with test data');
                console.log('- skipToChallenges() - skip to challenge detection');
                console.log('- skipToRecommendations() - skip to recommendations');
                console.log('- testCompleteFlow() - test entire workflow');
                console.log('- testWaitlistIntegration() - test waitlist redirect');
                console.log('- simulateError() - test error recovery');
                
                ErrorHandler.showUserError('Assessment initialized successfully!', 'success');
                
            } catch (error) {
                ErrorHandler.handleCriticalError('Application initialization failed', error, () => {
                    const mainContainer = DOMUtils.safeGetElement('main-assessment-container');
                    if (mainContainer) {
                        mainContainer.style.opacity = '1';
                        mainContainer.innerHTML = `
                            <div class="content-section" style="text-align: center;">
                                <h2 style="color: var(--color-accent-danger);">Emergency Mode</h2>
                                <p>The application failed to initialize properly but is running in emergency mode.</p>
                                <button class="btn btn-secondary" onclick="location.reload()">Reload Application</button>
                            </div>
                        `;
                    }
                });
            }
        }

        // =============================================================================
        // REPAIRED: ENHANCED DEBUG FUNCTIONS FOR NEW FEATURES
        // =============================================================================
        
        window.debugAssessment = function() {
            console.log('🔍 Enhanced Assessment Debug Info:', {
                state: assessmentState,
                responses: HSAssessmentService.responses,
                currentIndex: HSAssessmentService.currentIndex,
                totalQuestions: HSAssessmentService.allQuestions.length,
                errors: assessmentState.errors,
                lastError: assessmentState.lastError,
                cohorts: CohortTracker.cohorts,
                conversionMetrics: CohortTracker.getPerformanceMetrics(),
                exitIntentStatus: ExitIntentManager.hasShownIntent
            });
        };
        
        window.testErrorHandling = function() {
            console.log('🧪 Testing error handling systems');
            
            ErrorHandler.showUserError('This is a test error message');
            
            setTimeout(() => {
                ErrorHandler.showUserError('This is a test success message', 'success');
            }, 2000);
            
            console.log('DOM Safety Test:', DOMUtils.safeGetElement('non-existent-element'));
            console.log('Form Validation Test:', validateForm('user-details-form'));
        };
        
        window.simulateError = function() {
            try {
                throw new Error('Simulated error for testing recovery systems');
            } catch (error) {
                ErrorHandler.logError('Simulated error', error);
            }
        };
        
        window.testExitIntent = function() {
            console.log('🚨 Testing exit-intent system');
            
            // Set up conditions for exit-intent
            assessmentState.currentStep = 2;
            assessmentState.assessmentCompleted = false;
            HSAssessmentService.currentIndex = 5; // Simulate 5 questions answered
            ExitIntentManager.hasShownIntent = false;
            
            // Fill mock user details
            assessmentState.userDetails = {
                email: 'test@example.com',
                productName: 'Test Product'
            };
            
            // Trigger exit-intent modal
            ExitIntentManager.showExitIntentModal();
            
            console.log('✅ Exit-intent modal should be displayed');
        };
        
        window.testSocialSharing = function() {
            console.log('📱 Testing social sharing system');
            
            // Set up mock assessment data
            const mockAssessmentData = {
                score: 67,
                challenges: 4,
                riskLevel: 'High',
                focusArea: 'Buyer Understanding',
                revenueOpportunity: '$750K'
            };
            
            SocialShareGenerator.showSharingModal(mockAssessmentData);
            
            console.log('✅ Social sharing modal should be displayed');
        };
        
        window.viewConversionMetrics = function() {
            console.log('📊 Conversion Metrics & Cohort Analysis:');
            
            const metrics = CohortTracker.getPerformanceMetrics();
            console.table(metrics.conversionRates);
            
            console.log('Performance Summary:', {
                qualificationImprovement: metrics.qualificationImprovement,
                totalEvents: metrics.totalEvents,
                activeCohorts: metrics.activeCohorts
            });
            
            console.log('Detailed Events:', CohortTracker.events);
            
            return metrics;
        };
        
        window.skipToAnalytics = function() {
            console.log('⏭️ Skipping to analytics with test data');
            
            assessmentState.userDetails = {
                email: 'test@example.com',
                productName: 'Test Product',
                businessModel: 'b2b',
                productDescription: 'Test SaaS platform for enterprise automation',
                distinguishingFeature: 'AI-powered workflow optimization',
                customerCount: '11-50'
            };
            
            const mockResponses = {
                conversationConfidence: 4,
                valuePropositionSpecificity: 3,
                objectionPredictability: 'no',
                stakeholderAwareness: '1-2',
                buyerJourneyUnderstanding: 'no',
                championIdentification: 'some',
                referenceComfortLevel: 6,
                industrySpecificValue: 5,
                featureTranslationAbility: 3,
                technicalObjectionFrequency: 8,
                competitiveDifferentiation: 4,
                businessCaseCreation: 'no',
                successMetricClarity: 4,
                executiveReadiness: 'no'
            };
            
            Object.entries(mockResponses).forEach(([questionId, value]) => {
                HSAssessmentService.saveResponse(questionId, value);
                assessmentState.responses[questionId] = value;
            });
            
            // Track completion
            CohortTracker.trackUserJourney(
                assessmentState.sessionId,
                'assessment-qualified',
                'test-completion',
                { mockData: true, testFunction: 'skipToAnalytics' }
            );
            
            assessmentState.analysisResults = generateAnalyticsResults(mockResponses);
            assessmentState.assessmentCompleted = true;
            assessmentState.analyticsCompleted = true;
            
            showStep(3);
            displayAnalyticsResults(assessmentState.analysisResults);
        };
        
        window.skipToChallenges = function() {
            console.log('⏭️ Skipping to challenges');
            
            if (!assessmentState.analyticsCompleted) {
                skipToAnalytics();
                setTimeout(() => {
                    showStep(4);
                }, 1000);
            } else {
                showStep(4);
            }
        };
        
        window.skipToRecommendations = function() {
            console.log('⏭️ Skipping to recommendations');
            
            if (!assessmentState.challengesCompleted) {
                skipToChallenges();
                setTimeout(() => {
                    showStep(5);
                }, 3000);
            } else {
                showStep(5);
            }
        };
        
        window.testCompleteFlow = function() {
            console.log('🎯 Testing complete enhanced assessment flow');
            
            skipToAnalytics();
            
            setTimeout(() => {
                console.log('📊 Moving to challenges...');
                showStep(4);
            }, 3000);
            
            setTimeout(() => {
                console.log('💡 Moving to recommendations...');
                showStep(5);
            }, 6000);
            
            setTimeout(() => {
                console.log('📱 Testing social sharing...');
                testSocialSharing();
            }, 8000);
            
            setTimeout(() => {
                console.log('📊 Showing conversion metrics...');
                viewConversionMetrics();
            }, 10000);
            
            setTimeout(() => {
                console.log('✅ Enhanced complete flow test finished!');
                ErrorHandler.showUserError('Enhanced workflow test completed successfully!', 'success');
            }, 12000);
        };
        
        window.testWaitlistIntegration = function() {
            console.log('🚀 Testing waitlist integration');
            
            if (!assessmentState.recommendationsCompleted) {
                skipToRecommendations();
                setTimeout(() => {
                    testWaitlistIntegration();
                }, 4000);
                return;
            }
            
            const assessmentContext = {
                score: assessmentState.analysisResults?.overall?.score || 45,
                challenges: assessmentState.detectedChallenges?.summary?.totalChallenges || 6,
                riskLevel: assessmentState.detectedChallenges?.summary?.overallRisk || 'Critical',
                focusArea: assessmentState.detectedChallenges?.summary?.focusArea || 'Buyer Understanding',
                businessModel: 'b2b',
                customerCount: '11-50',
                revenueOpportunity: '$750K',
                urgencyLevel: 'Critical',
                qualified: true,
                source: 'hs_assessment_tool',
                
                // Enhanced analytics data
                conversionPath: 'assessment-qualified',
                totalEvents: CohortTracker.events.length,
                exitIntentShown: ExitIntentManager.hasShownIntent,
                socialShareViewed: false,
                mobileUser: window.innerWidth <= 768
            };
            
            const waitlistUrl = buildWaitlistUrl(assessmentContext);
            
            console.log('Generated Waitlist URL:', waitlistUrl);
            console.log('Assessment Context:', assessmentContext);
            
            ErrorHandler.showUserError('Waitlist integration test successful! Check console for full URL with analytics.', 'success');
            
            return {
                context: assessmentContext,
                url: waitlistUrl,
                conversionMetrics: CohortTracker.getPerformanceMetrics()
            };
        };

        // =============================================================================
        // APPLICATION STARTUP
        // =============================================================================
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApplication);
        } else {
            initializeApplication();
        }
        
        console.log('✅ H&S Assessment - Complete workflow implemented and functional!');
        console.log('🔧 Features: DOM safety, error handling, analytics, challenge detection, recommendations, waitlist integration');
        console.log('🚀 Ready for: Full assessment workflow from start to waitlist signup');
    </script>
</body>
</html> 
